<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shark Bounty Admin Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <link rel="icon" href="https://github.com/s42144/Shark-Bounty/blob/dedf1f3379f4a52180a500e818e467dcd99f56c9/1057118.png?raw=true">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    :root {
      --primary: #27cdfc;
      --secondary: #ff61a6;
      --gradient: linear-gradient(120deg, #241132 0%, #ff459e 100%);
      --card-bg: rgba(255,255,255,0.95);
      --panel-bg: rgba(28,40,61,0.95);
      --accent: #27cdfc;
      --accent2: #ff61a6;
      --btn-gradient: linear-gradient(95deg, #27cdfc 0%, #ff61a6 100%);
      --shadow: 0 4px 32px rgba(0,0,0,0.15);
      --border-radius: 16px;
      --success: #34d399;
      --warning: #fbbf24;
      --danger: #ef4444;
      --info: #3b82f6;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--gradient);
      background-attachment: fixed;
      min-height: 100vh;
      color: #333;
      overflow-x: hidden;
    }
    
    .admin-wrapper {
      min-height: 100vh;
      padding: 20px;
    }
    
    .admin-header {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 20px 30px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .admin-logo-section {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .admin-logo {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 3px solid var(--accent2);
    }
    
    .admin-title {
      font-size: 1.5rem;
      font-weight: 900;
      background: var(--btn-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .admin-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .logout-btn {
      background: var(--btn-gradient);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .logout-btn:hover {
      transform: translateY(-2px);
    }
    
    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 24px;
      box-shadow: var(--shadow);
      border-left: 5px solid var(--accent);
      transition: transform 0.2s;
    }
    
    .stat-card:hover {
      transform: translateY(-4px);
    }
    
    .stat-card:nth-child(2) {
      border-left-color: var(--accent2);
    }
    
    .stat-card:nth-child(3) {
      border-left-color: #ffd23e;
    }
    
    .stat-card:nth-child(4) {
      border-left-color: #34d399;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 8px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: 900;
      color: #333;
      margin-bottom: 5px;
    }
    
    .stat-change {
      font-size: 0.85rem;
      color: #34d399;
      font-weight: 600;
    }
    
    /* Balance Control Modal */
    .balance-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    
    .balance-modal.show {
      display: flex;
    }
    
    .balance-modal-content {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 30px;
      max-width: 400px;
      width: 90%;
      box-shadow: var(--shadow);
      text-align: center;
    }
    
    .balance-modal-title {
      font-size: 1.5rem;
      font-weight: 900;
      margin-bottom: 20px;
      background: var(--btn-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .balance-input-group {
      margin: 20px 0;
    }
    
    .balance-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1.1rem;
      text-align: center;
      margin-bottom: 15px;
    }
    
    .balance-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .balance-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1rem;
    }
    
    .balance-btn.increase {
      background: #34d399;
      color: #fff;
    }
    
    .balance-btn.decrease {
      background: #ef4444;
      color: #fff;
    }
    
    .balance-btn.cancel {
      background: #6c757d;
      color: #fff;
    }
    
    .balance-btn:hover {
      transform: translateY(-2px);
    }
    
    /* Tabs Navigation */
    .tabs-nav {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 10px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      display: flex;
      gap: 10px;
      overflow-x: auto;
      flex-wrap: wrap;
    }
    
    .tab-btn {
      background: transparent;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      color: #666;
      white-space: nowrap;
    }
    
    .tab-btn.active {
      background: var(--btn-gradient);
      color: #fff;
      box-shadow: 0 4px 12px rgba(255,97,166,0.3);
    }
    
    .tab-btn:hover:not(.active) {
      background: #f0f0f0;
    }
    
    /* Tab Content */
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Cards */
    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 24px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .card-title {
      font-size: 1.3rem;
      font-weight: 800;
      color: #333;
    }
    
    /* Forms */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .form-label {
      font-weight: 700;
      color: #333;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .form-input, .form-textarea, .form-select {
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s;
      background: #f8f9fa;
    }
    
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: var(--accent);
      background: #fff;
      box-shadow: 0 0 0 4px rgba(39,205,252,0.1);
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1rem;
    }
    
    .btn-primary {
      background: var(--btn-gradient);
      color: #fff;
      box-shadow: 0 4px 12px rgba(255,97,166,0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255,97,166,0.4);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: #fff;
    }
    
    .btn-danger {
      background: #ef4444;
      color: #fff;
    }
    
    .btn-success {
      background: #34d399;
      color: #fff;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 0.85rem;
    }
    
    /* Tables */
    .table-container {
      overflow-x: auto;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }
    
    .data-table thead {
      background: linear-gradient(135deg, #27cdfc 0%, #ff61a6 100%);
      color: #fff;
    }
    
    .data-table th {
      padding: 14px 12px;
      text-align: left;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
    }
    
    .data-table td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .data-table tbody tr:hover {
      background: #f8f9fa;
    }
    
    .data-table img {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
    }
    
    /* Action Buttons in Table */
    .action-btns {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    /* Balance Control Section */
    .balance-control-section {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      border-left: 5px solid var(--accent);
    }
    
    .balance-control-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .balance-control-title {
      font-size: 1.3rem;
      font-weight: 800;
      color: #333;
    }
    
    .balance-control-instructions {
      color: #666;
      margin-bottom: 20px;
      font-size: 0.9rem;
    }
    
    /* Search Bar */
    .search-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
    }
    
    /* User Info Card */
    .user-info-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border-radius: var(--border-radius);
      padding: 20px;
      margin-top: 15px;
    }
    
    .user-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .user-info-item {
      background: rgba(255,255,255,0.15);
      padding: 12px;
      border-radius: 10px;
      backdrop-filter: blur(10px);
    }
    
    .user-info-label {
      font-size: 0.8rem;
      opacity: 0.9;
      margin-bottom: 5px;
    }
    
    .user-info-value {
      font-size: 1.1rem;
      font-weight: 700;
    }
    
    /* Profile Sections Management */
    .profile-section-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .profile-section-item {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      border: 2px solid #e0e0e0;
      transition: all 0.3s;
    }
    
    .profile-section-item:hover {
      border-color: var(--accent);
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .profile-section-item img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    
    .profile-section-name {
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
    }
    
    .profile-section-link {
      font-size: 0.85rem;
      color: #666;
      word-break: break-all;
      margin-bottom: 10px;
    }
    
    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #fff;
      border-radius: 12px;
      padding: 16px 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 12px;
      transform: translateX(400px);
      transition: transform 0.3s;
      max-width: 350px;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      border-left: 4px solid #34d399;
    }
    
    .notification.error {
      border-left: 4px solid #ef4444;
    }
    
    .notification.info {
      border-left: 4px solid #3b82f6;
    }
    
    .notification-icon {
      font-size: 1.5rem;
    }
    
    .notification-content {
      flex: 1;
    }
    
    .notification-title {
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .notification-message {
      font-size: 0.9rem;
      color: #666;
    }
    
    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    
    .empty-state-text {
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .admin-header {
        flex-direction: column;
        text-align: center;
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .tabs-nav {
        flex-direction: column;
      }
      
      .tab-btn {
        width: 100%;
      }
      
      .notification {
        right: 10px;
        left: 10px;
        max-width: none;
      }
      
      .balance-buttons {
        flex-direction: column;
      }
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    
    /* Badge */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
    }
    
    .badge-success {
      background: #d1fae5;
      color: #065f46;
    }
    
    .badge-danger {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .badge-warning {
      background: #fef3c7;
      color: #92400e;
    }
    
    .badge-info {
      background: #dbeafe;
      color: #1e40af;
    }
    
    /* New styles for enhanced admin panel */
    .wallet-addresses-section {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      border-left: 5px solid #ffd700;
    }
    
    .copy-btn {
      padding: 6px 12px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }
    
    .copy-btn:hover {
      background: var(--accent2);
    }
    
    .export-btn {
      padding: 8px 16px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .export-btn:hover {
      background: #5a6268;
    }
    
    .image-upload-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .image-preview {
      width: 100%;
      height: 150px;
      border-radius: 10px;
      border: 2px dashed #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .image-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    
    .upload-btn-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }
    
    .upload-btn {
      background: var(--btn-gradient);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .upload-btn-wrapper input[type=file] {
      font-size: 100px;
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      cursor: pointer;
    }
    
    .ui-customization-section {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      border-left: 5px solid #9333ea;
    }
    
    .color-picker-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .color-picker-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .color-picker-label {
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .color-picker-input {
      width: 100%;
      height: 40px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    
    .online-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
    }
    
    .online-indicator.online {
      background-color: #34d399;
      box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.3);
    }
    
    .online-indicator.offline {
      background-color: #ef4444;
      box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3);
    }
    
    .device-info-pill {
      display: inline-block;
      padding: 4px 8px;
      background: #f3f4f6;
      border-radius: 20px;
      font-size: 0.75rem;
      margin-right: 5px;
      margin-bottom: 5px;
      white-space: nowrap;
    }
    
    .country-flag {
      width: 20px;
      height: 15px;
      margin-right: 5px;
      vertical-align: middle;
      border-radius: 2px;
    }
    
    .telegram-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .telegram-icon {
      color: #0088cc;
      font-size: 1.2rem;
    }
    
    .wallet-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .wallet-table th {
      background: #f3f4f6;
      padding: 12px;
      text-align: left;
      font-weight: 600;
    }
    
    .wallet-table td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .wallet-address {
      font-family: monospace;
      font-size: 0.9rem;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .wallet-balance {
      font-weight: 600;
      color: #059669;
    }
    
    .user-activity-log {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-top: 15px;
    }
    
    .activity-item {
      padding: 10px 15px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .activity-item:last-child {
      border-bottom: none;
    }
    
    .activity-time {
      font-size: 0.8rem;
      color: #6b7280;
    }
    
    .activity-action {
      font-weight: 500;
    }
    
    .map-container {
      height: 300px;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 20px;
    }
  </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
  <!-- Admin Dashboard -->
  <div class="admin-wrapper" id="adminDashboard">
    <!-- Header -->
    <div class="admin-header fade-in">
      <div class="admin-logo-section">
        <img src="https://github.com/s42144/Shark-Bounty/blob/dedf1f3379f4a52180a500e818e467dcd99f56c9/1057118.png?raw=true" alt="Logo" class="admin-logo">
        <div>
          <h1 class="admin-title">Shark Bounty</h1>
          <p style="color: #666; font-size: 0.9rem; margin-top: 4px;">Admin Control Panel</p>
        </div>
      </div>
      <div class="admin-actions">
        <div style="text-align: right; margin-right: 10px;">
          <div style="font-weight: 600; color: #333;">Admin Panel</div>
          <div style="font-size: 0.8rem; color: #666;">Bot API: 8237387201:AAFI98932KS3M5uJDLaTbu27FCFOJ40wwxI</div>
        </div>
        <button class="logout-btn">Logout</button>
      </div>
    </div>

    <!-- Dashboard Stats -->
    <div class="dashboard-grid fade-in">
      <div class="stat-card">
        <div class="stat-label">Total Users</div>
        <div class="stat-value" id="totalUsers">0</div>
        <div class="stat-change" id="usersChange">+0 today</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Balance</div>
        <div class="stat-value" id="totalBalance">0 SHB</div>
        <div class="stat-change" id="balanceChange">+0 today</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Online Users</div>
        <div class="stat-value" id="onlineUsers">0</div>
        <div class="stat-change" id="onlineChange">Active now</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Active Tasks</div>
        <div class="stat-value" id="totalTasks">0</div>
        <div class="stat-change" id="tasksChange">Active</div>
      </div>
    </div>

    <!-- Balance Control Section -->
    <div class="balance-control-section fade-in">
      <div class="balance-control-header">
        <h2 class="balance-control-title">üí∞ Balance Control</h2>
        <span class="badge badge-info">Quick Balance Management</span>
      </div>
      <p class="balance-control-instructions">
        Search for a user and adjust their SHB balance instantly. Enter positive number to increase, negative to decrease.
      </p>
      <div class="search-bar">
        <input type="text" class="search-input" id="balanceUserId" placeholder="Enter User ID or Telegram Username...">
        <input type="number" class="search-input" id="balanceAmount" placeholder="Amount (+/-)" style="max-width: 150px;">
        <button class="btn btn-primary" id="searchBalanceBtn">Find User</button>
      </div>
      <div id="balanceUserInfo"></div>
    </div>

    <!-- Tabs Navigation -->
    <div class="tabs-nav fade-in">
      <button class="tab-btn active" data-tab="overview">üìä Overview</button>
      <button class="tab-btn" data-tab="tasks">üìã Tasks</button>
      <button class="tab-btn" data-tab="users">üë• Users</button>
      <button class="tab-btn" data-tab="profile-sections">üéØ Profile Sections</button>
      <button class="tab-btn" data-tab="redeem">üéÅ Redeem Codes</button>
      <button class="tab-btn" data-tab="analytics">üìà Analytics</button>
      <button class="tab-btn" data-tab="wallets">üíº Wallet Addresses</button>
      <button class="tab-btn" data-tab="ui-settings">üé® UI Settings</button>
    </div>

    <!-- Overview Tab -->
    <div class="tab-content active" id="overview">
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="card-title">üìä System Overview</h2>
        </div>
        <div class="chart-container">
          <canvas id="overviewChart"></canvas>
        </div>
      </div>
      
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="card-title">üî• Recent Activity</h2>
        </div>
        <div id="recentActivity">
          <div class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <div class="empty-state-text">Loading activity data...</div>
          </div>
        </div>
      </div>
      
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="card-title">üåé User Locations</h2>
        </div>
        <div class="map-container" id="userLocationsMap">
          <div class="empty-state">
            <div class="empty-state-icon">üó∫Ô∏è</div>
            <div class="empty-state-text">User location map will appear here</div>
          </div>
        </div>
        <div style="margin-top: 20px;">
          <div style="font-weight: 700; margin-bottom: 10px;">Top Countries</div>
          <div id="topCountriesList" style="display: flex; flex-wrap: wrap; gap: 10px;">
            <div class="device-info-pill">Loading countries...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tasks Tab -->
    <div class="tab-content" id="tasks">
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="card-title">‚ûï Add New Task</h2>
        </div>
        <form id="taskForm">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Task Name</label>
              <input type="text" class="form-input" id="taskName" placeholder="Enter task name" required>
            </div>
            <div class="form-group">
              <label class="form-label">Reward (SHB)</label>
              <input type="number" class="form-input" id="taskAmount" placeholder="1000" min="1" required>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Task Photo</label>
            <div class="image-upload-container">
              <div class="image-preview" id="taskPhotoPreview">
                <span>No image selected</span>
              </div>
              <div style="display: flex; gap: 10px;">
                <div class="upload-btn-wrapper">
                  <button type="button" class="upload-btn">Upload Image</button>
                  <input type="file" id="taskPhotoUpload" accept="image/*" />
                </div>
                <span style="display: flex; align-items: center; color: #666;">OR</span>
                <input type="url" class="form-input" id="taskPhoto" placeholder="Enter image URL" style="flex: 1;">
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Task Link</label>
            <input type="url" class="form-input" id="taskLink" placeholder="https://..." required>
          </div>
          
          <button type="submit" class="btn btn-primary">
            <span id="taskBtnText">Add Task</span>
          </button>
        </form>
      </div>

      <div class="card fade-in">
        <div class="card-header">
          <h2 class="card-title">üìã All Tasks</h2>
          <span class="badge badge-info" id="taskCount">0 Tasks</span>
        </div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Photo</th>
                <th>Name</th>
                <th>Reward</th>
                <th>Link</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tasksTableBody">
              <tr>
                <td colspan="5" style="text-align: center; padding: 40px;">
                  <div class="loading-spinner" style="margin: 0 auto;"></div>
                  <p style="margin-top: 10px; color: #999;">Loading tasks...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Users Tab -->
    <div class="tab-content" id="users">
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="card-title">üîç Search User</h2>
        </div>
        <div class="search-bar">
          <input type="text" class="search-input" id="searchUserId" placeholder="Enter User ID or Telegram Username...">
          <button class="btn btn-primary" id="searchUserBtn">Search</button>
        </div>
        <div id="userInfoContainer"></div>
      </div>

      <div class="card fade-in">
        <div class="card-header">
          <h2 class="card-title">üë• All Users</h2>
          <span class="badge badge-info" id="userCount">0 Users</span>
        </div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>User ID</th>
                <th>Telegram</th>
                <th>Balance</th>
                <th>Status</th>
                <th>Device</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr>
                <td colspan="6" style="text-align: center; padding: 40px;">
                  <div class="loading-spinner" style="margin: 0 auto;"></div>
                  <p style="margin-top: 10px; color: #999;">Loading users...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Profile Sections Tab -->
    <div class="tab-content" id="profile-sections">
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="card-title">‚ûï Add Profile Section</h2>
        </div>
        <form id="profileSectionForm">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Section Name</label>
              <input type="text" class="form-input" id="sectionName" placeholder="e.g., RoadMap" required>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Section Image</label>
            <div class="image-upload-container">
              <div class="image-preview" id="sectionImagePreview">
                <span>No image selected</span>
              </div>
              <div style="display: flex; gap: 10px;">
                <div class="upload-btn-wrapper">
                  <button type="button" class="upload-btn">Upload Image</button>
                  <input type="file" id="sectionImageUpload" accept="image/*" />
                </div>
                <span style="display: flex; align-items: center; color: #666;">OR</span>
                <input type="url" class="form-input" id="sectionImage" placeholder="Enter image URL" style="flex: 1;">
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Link URL</label>
            <input type="url" class="form-input" id="sectionLink" placeholder="https://..." required>
          </div>
          
          <button type="submit" class="btn btn-primary">
            <span id="sectionBtnText">Add Section</span>
          </button>
        </form>
      </div>

      <div class="card fade-in">
        <div class="card-header">
          <h2 class="card-title">üéØ Profile Sections</h2>
          <span class="badge badge-info" id="sectionCount">0 Sections</span>
        </div>
        <div class="profile-section-preview" id="profileSectionsContainer">
          <div class="empty-state">
            <div class="empty-state-icon">üéØ</div>
            <div class="empty-state-text">No sections yet. Add your first section!</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Redeem Codes Tab -->
    <div class="tab-content" id="redeem">
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="card-title">‚ûï Generate Redeem Code</h2>
        </div>
        <form id="redeemForm">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">4-Digit Code</label>
              <input type="text" class="form-input" id="redeemCode" placeholder="1234" maxlength="4" pattern="[0-9]{4}" required>
            </div>
            <div class="form-group" style="display: flex; align-items: flex-end;">
              <button type="submit" class="btn btn-primary" style="width: 100%;">Generate Code</button>
            </div>
          </div>
        </form>
      </div>

      <div class="card fade-in">
        <div class="card-header">
          <h2 class="card-title">üéÅ Active Redeem Codes</h2>
          <span class="badge badge-success" id="redeemCount">0 Codes</span>
        </div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="redeemTableBody">
              <tr>
                <td colspan="3" style="text-align: center; padding: 40px;">
                  <div class="empty-state">
                    <div class="empty-state-icon">üéÅ</div>
                    <div class="empty-state-text">No redeem codes yet</div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Analytics Tab -->
    <div class="tab-content" id="analytics">
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="card-title">üìà User Growth</h2>
        </div>
        <div class="chart-container">
          <canvas id="userGrowthChart"></canvas>
        </div>
      </div>

      <div class="card fade-in">
        <div class="card-header">
          <h2 class="card-title">üí∞ Balance Distribution</h2>
        </div>
        <div class="chart-container">
          <canvas id="balanceChart"></canvas>
        </div>
      </div>
      
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="card-title">üì± Device Distribution</h2>
        </div>
        <div class="chart-container">
          <canvas id="deviceChart"></canvas>
        </div>
      </div>
      
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="card-title">‚è±Ô∏è User Activity</h2>
        </div>
        <div class="chart-container">
          <canvas id="activityChart"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Wallet Addresses Tab -->
    <div class="tab-content" id="wallets">
      <div class="wallet-addresses-section fade-in">
        <div class="balance-control-header">
          <h2 class="balance-control-title">üíº Wallet Addresses</h2>
          <div>
            <button class="export-btn" id="exportWallets">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
              </svg>
              Export to TXT
            </button>
          </div>
        </div>
        <p class="balance-control-instructions">
          View and manage all user wallet addresses. Use the copy button to copy individual addresses or export all addresses to a text file.
        </p>
        
        <div class="table-container">
          <table class="wallet-table">
            <thead>
              <tr>
                <th>User ID</th>
                <th>Telegram</th>
                <th>Wallet Address</th>
                <th>Balance</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="walletsTableBody">
              <tr>
                <td colspan="5" style="text-align: center; padding: 40px;">
                  <div class="loading-spinner" style="margin: 0 auto;"></div>
                  <p style="margin-top: 10px; color: #999;">Loading wallet addresses...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- UI Settings Tab -->
    <div class="tab-content" id="ui-settings">
      <div class="ui-customization-section fade-in">
        <div class="balance-control-header">
          <h2 class="balance-control-title">üé® UI Customization</h2>
          <span class="badge badge-info">App Appearance</span>
        </div>
        <p class="balance-control-instructions">
          Customize the appearance of the main app. Changes will be applied to all users immediately.
        </p>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Color Scheme</h3>
          </div>
          
          <div class="color-picker-group">
            <div class="color-picker-item">
              <label class="color-picker-label">Primary Color</label>
              <input type="color" class="color-picker-input" id="primaryColor" value="#27cdfc">
            </div>
            <div class="color-picker-item">
              <label class="color-picker-label">Secondary Color</label>
              <input type="color" class="color-picker-input" id="secondaryColor" value="#ff61a6">
            </div>
            <div class="color-picker-item">
              <label class="color-picker-label">Background Start</label>
              <input type="color" class="color-picker-input" id="bgColorStart" value="#241132">
            </div>
            <div class="color-picker-item">
              <label class="color-picker-label">Background End</label>
              <input type="color" class="color-picker-input" id="bgColorEnd" value="#ff459e">
            </div>
          </div>
          
          <button class="btn btn-primary" id="saveColorScheme" style="margin-top: 15px;">Save Color Scheme</button>
        </div>
        
        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <h3 class="card-title">Home Button</h3>
          </div>
          
          <div class="form-group">
            <label class="form-label">Home Button Image</label>
            <div class="image-upload-container">
              <div class="image-preview" id="homeButtonPreview">
                <img src="https://github.com/akhterefti-del/Shark/blob/e7c848276e3281e80d912cab430f8f62e9cf679e/homebtn%20(1).png?raw=true" alt="Home Button">
              </div>
              <div style="display: flex; gap: 10px;">
                <div class="upload-btn-wrapper">
                  <button type="button" class="upload-btn">Upload Image</button>
                  <input type="file" id="homeButtonUpload" accept="image/*" />
                </div>
                <span style="display: flex; align-items: center; color: #666;">OR</span>
                <input type="url" class="form-input" id="homeButtonUrl" placeholder="Enter image URL" style="flex: 1;" value="https://github.com/akhterefti-del/Shark/blob/e7c848276e3281e80d912cab430f8f62e9cf679e/homebtn%20(1).png?raw=true">
              </div>
            </div>
          </div>
          
          <button class="btn btn-primary" id="saveHomeButton" style="margin-top: 15px;">Save Home Button</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Balance Control Modal -->
  <div class="balance-modal" id="balanceModal">
    <div class="balance-modal-content">
      <h2 class="balance-modal-title">üí∞ Adjust Balance</h2>
      <div class="balance-input-group">
        <p id="balanceUserName" style="font-weight: 600; margin-bottom: 10px;"></p>
        <p id="balanceUserId" style="color: #666; margin-bottom: 15px;"></p>
        <p id="currentBalance" style="font-size: 1.2rem; margin-bottom: 20px;"></p>
        <input type="number" class="balance-input" id="balanceAdjustment" placeholder="Enter amount (+/-)" step="1">
        <p style="font-size: 0.85rem; color: #666; margin-top: 10px;">
          Enter positive number to increase, negative to decrease
        </p>
      </div>
      <div class="balance-buttons">
        <button class="balance-btn increase" onclick="adjustBalance(true)">Increase</button>
        <button class="balance-btn decrease" onclick="adjustBalance(false)">Decrease</button>
        <button class="balance-btn cancel" onclick="closeBalanceModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Notification Container -->
  <div id="notificationContainer"></div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAHofuS76xf2oGPaJqEtopmcxdoJzjkDL4",
      authDomain: "zmex-investments.firebaseapp.com",
      databaseURL: "https://zmex-investments-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "zmex-investments",
      storageBucket: "zmex-investments.appspot.com",
      messagingSenderId: "971623941364",
      appId: "1:971623941364:web:6c65604fc45c3f64e74aa1",
      measurementId: "G-KQ1LYP77JF"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    // Global Variables
    let editingTaskId = null;
    let editingSectionId = null;
    let currentBalanceUserId = null;
    let currentBalanceUser = null;
    let userDeviceData = {};
    let userLocationData = {};
    let onlineUsers = 0;
    let totalUsers = 0;
    let walletAddresses = [];
    let userTelegramData = {};
    let userActivityData = [];

    // Notification System
    function showNotification(title, message, type = 'success') {
      const container = document.getElementById('notificationContainer');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      
      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        info: '‚ÑπÔ∏è'
      };
      
      notification.innerHTML = `
        <div class="notification-icon">${icons[type]}</div>
        <div class="notification-content">
          <div class="notification-title">${title}</div>
          <div class="notification-message">${message}</div>
        </div>
      `;
      
      container.appendChild(notification);
      
      setTimeout(() => notification.classList.add('show'), 100);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Initialize Dashboard
    function initializeDashboard() {
      loadStats();
      loadTasks();
      loadUsers();
      loadProfileSections();
      loadRedeemCodes();
      loadWalletAddresses();
      initializeCharts();
      setupImageUploads();
      
      setInterval(loadStats, 5000);
      setInterval(updateOnlineUsers, 10000);
    }

    // Load Statistics
    async function loadStats() {
      try {
        const usersSnap = await db.ref('users').once('value');
        const tasksSnap = await db.ref('tasks').once('value');
        
        let totalUsersCount = 0;
        let totalBalance = 0;
        let totalAds = 0;
        let onlineUsersCount = 0;
        const now = Math.floor(Date.now() / 1000);
        
        usersSnap.forEach(userSnap => {
          totalUsersCount++;
          const user = userSnap.val();
          totalBalance += (user.balance || 0);
          
          if (user.adStats) {
            totalAds += (user.adStats.lifetime || 0);
          }
          
          // Check if user is online (active in the last 5 minutes)
          if (user.lastSeen && (now - user.lastSeen) < 300) {
            onlineUsersCount++;
          }
          
          // Store device data
          if (user.deviceInfo) {
            const deviceType = user.deviceInfo.type || 'Unknown';
            userDeviceData[deviceType] = (userDeviceData[deviceType] || 0) + 1;
          }
          
          // Store location data
          if (user.location) {
            const country = user.location.country || 'Unknown';
            userLocationData[country] = (userLocationData[country] || 0) + 1;
          }
          
          // Store Telegram data
          if (user.telegramUsername) {
            userTelegramData[userSnap.key] = {
              username: user.telegramUsername,
              firstName: user.telegramFirstName || '',
              lastName: user.telegramLastName || ''
            };
          }
        });
        
        totalUsers = totalUsersCount;
        onlineUsers = onlineUsersCount;
        
        const totalTasks = tasksSnap.numChildren();
        
        document.getElementById('totalUsers').textContent = totalUsersCount.toLocaleString();
        document.getElementById('totalBalance').textContent = totalBalance.toLocaleString() + ' SHB';
        document.getElementById('onlineUsers').textContent = onlineUsersCount.toLocaleString();
        document.getElementById('totalTasks').textContent = totalTasks;
        
        document.getElementById('onlineChange').textContent = `${Math.round((onlineUsersCount / totalUsersCount) * 100)}% of total`;
        
        document.getElementById('taskCount').textContent = `${totalTasks} Tasks`;
        document.getElementById('userCount').textContent = `${totalUsersCount} Users`;
        
        updateTopCountries();
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Update Online Users
    function updateOnlineUsers() {
      const now = Math.floor(Date.now() / 1000);
      
      db.ref('users').orderByChild('lastSeen').startAt(now - 300).once('value', (snap) => {
        const onlineUsersCount = snap.numChildren();
        onlineUsers = onlineUsersCount;
        
        document.getElementById('onlineUsers').textContent = onlineUsersCount.toLocaleString();
        document.getElementById('onlineChange').textContent = `${Math.round((onlineUsersCount / totalUsers) * 100)}% of total`;
      });
    }

    // Update Top Countries
    function updateTopCountries() {
      const topCountriesList = document.getElementById('topCountriesList');
      if (!topCountriesList) return;
      
      const countries = Object.entries(userLocationData)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
      
      if (countries.length === 0) {
        topCountriesList.innerHTML = '<div class="device-info-pill">No country data available</div>';
        return;
      }
      
      topCountriesList.innerHTML = '';
      countries.forEach(([country, count]) => {
        const countryCode = getCountryCode(country);
        const pill = document.createElement('div');
        pill.className = 'device-info-pill';
        pill.innerHTML = `
          <img src="https://flagcdn.com/w20/${countryCode.toLowerCase()}.png" class="country-flag" alt="${country}">
          ${country}: ${count}
        `;
        topCountriesList.appendChild(pill);
      });
    }

    // Helper function to get country code
    function getCountryCode(countryName) {
      const countryCodes = {
        'United States': 'us',
        'India': 'in',
        'Russia': 'ru',
        'China': 'cn',
        'Brazil': 'br',
        'Indonesia': 'id',
        'Pakistan': 'pk',
        'Nigeria': 'ng',
        'Bangladesh': 'bd',
        'Japan': 'jp',
        'Mexico': 'mx',
        'Philippines': 'ph',
        'Vietnam': 'vn',
        'Germany': 'de',
        'United Kingdom': 'gb',
        'France': 'fr',
        'Italy': 'it',
        'Turkey': 'tr',
        'Spain': 'es',
        'Ukraine': 'ua',
        'Unknown': 'xx'
      };
      
      return countryCodes[countryName] || 'xx';
    }

    // Balance Control Functions
    document.getElementById('searchBalanceBtn').addEventListener('click', async () => {
      const userIdOrUsername = document.getElementById('balanceUserId').value.trim();
      
      if (!userIdOrUsername) {
        showNotification('Error', 'Please enter a user ID or Telegram username', 'error');
        return;
      }
      
      try {
        // First try to find by user ID
        let snapshot = await db.ref('users/' + userIdOrUsername).once('value');
        
        // If not found, try to find by Telegram username
        if (!snapshot.exists()) {
          const usersSnapshot = await db.ref('users').orderByChild('telegramUsername').equalTo(userIdOrUsername).once('value');
          
          if (usersSnapshot.numChildren() > 0) {
            usersSnapshot.forEach((childSnapshot) => {
              snapshot = childSnapshot;
            });
          } else {
            showNotification('Error', 'User not found', 'error');
            document.getElementById('balanceUserInfo').innerHTML = '';
            return;
          }
        }
        
        const userId = snapshot.key;
        const user = snapshot.val();
        currentBalanceUserId = userId;
        currentBalanceUser = user;
        
        const telegramInfo = user.telegramUsername ? 
          `<div class="telegram-info">
            <span class="telegram-icon">üì±</span>
            <span>@${user.telegramUsername}</span>
          </div>` : '';
        
        const deviceInfo = user.deviceInfo ? 
          `<div class="device-info-pill">${user.deviceInfo.type || 'Unknown'}</div>
           <div class="device-info-pill">${user.deviceInfo.os || 'Unknown OS'}</div>` : '';
        
        const locationInfo = user.location ? 
          `<div class="device-info-pill">
            <img src="https://flagcdn.com/w20/${getCountryCode(user.location.country || 'Unknown').toLowerCase()}.png" class="country-flag" alt="${user.location.country || 'Unknown'}">
            ${user.location.country || 'Unknown'}
          </div>` : '';
        
        const isOnline = user.lastSeen && (Math.floor(Date.now() / 1000) - user.lastSeen < 300);
        const statusIndicator = `<span class="online-indicator ${isOnline ? 'online' : 'offline'}"></span>`;
        
        document.getElementById('balanceUserInfo').innerHTML = `
          <div class="user-info-card">
            <h3 style="margin-bottom: 15px;">User Found ${statusIndicator} ${isOnline ? 'Online' : 'Offline'}</h3>
            <div style="margin-bottom: 10px;">${telegramInfo}</div>
            <div class="user-info-grid">
              <div class="user-info-item">
                <div class="user-info-label">User ID</div>
                <div class="user-info-value">${userId}</div>
              </div>
              <div class="user-info-item">
                <div class="user-info-label">Current Balance</div>
                <div class="user-info-value">${(user.balance || 0).toLocaleString()} SHB</div>
              </div>
              <div class="user-info-item">
                <div class="user-info-label">Energy</div>
                <div class="user-info-value">${user.energy || 0} / ${user.maxEnergy || 1200}</div>
              </div>
              <div class="user-info-item">
                <div class="user-info-label">Multi Tap</div>
                <div class="user-info-value">${user.multiTap || 1}</div>
              </div>
            </div>
            <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 5px;">
              ${deviceInfo}
              ${locationInfo}
            </div>
            <div style="margin-top: 15px;">
              <button class="btn btn-primary" onclick="openBalanceModal('${userId}', '${user.balance || 0}')">
                Adjust Balance
              </button>
            </div>
          </div>
        `;
      } catch (error) {
        showNotification('Error', error.message, 'error');
      }
    });

    function openBalanceModal(userId, currentBalance) {
      currentBalanceUserId = userId;
      document.getElementById('balanceUserName').textContent = 'User ID: ' + userId;
      document.getElementById('balanceUserId').textContent = 'Current Balance: ' + parseInt(currentBalance).toLocaleString() + ' SHB';
      document.getElementById('currentBalance').textContent = 'Current: ' + parseInt(currentBalance).toLocaleString() + ' SHB';
      document.getElementById('balanceAdjustment').value = '';
      document.getElementById('balanceModal').classList.add('show');
    }

    function closeBalanceModal() {
      document.getElementById('balanceModal').classList.remove('show');
      currentBalanceUserId = null;
      currentBalanceUser = null;
    }

    window.adjustBalance = async function(isIncrease) {
      const adjustment = parseInt(document.getElementById('balanceAdjustment').value);
      
      if (isNaN(adjustment) || adjustment === 0) {
        showNotification('Error', 'Please enter a valid amount', 'error');
        return;
      }
      
      if (!currentBalanceUserId) {
        showNotification('Error', 'No user selected', 'error');
        return;
      }
      
      try {
        const currentBalance = currentBalanceUser.balance || 0;
        let newBalance = currentBalance;
        
        if (isIncrease) {
          newBalance = currentBalance + Math.abs(adjustment);
        } else {
          newBalance = currentBalance - Math.abs(adjustment);
          if (newBalance < 0) newBalance = 0;
        }
        
        await db.ref('users/' + currentBalanceUserId).update({ balance: newBalance });
        
        // Log the activity
        await db.ref('admin/activity').push({
          type: 'balance_adjustment',
          userId: currentBalanceUserId,
          oldBalance: currentBalance,
          newBalance: newBalance,
          adjustment: isIncrease ? Math.abs(adjustment) : -Math.abs(adjustment),
          timestamp: Math.floor(Date.now() / 1000)
        });
        
        const action = isIncrease ? 'increased' : 'decreased';
        showNotification('Success', `Balance ${action} by ${Math.abs(adjustment)} SHB!`, 'success');
        
        // Update the balance display
        document.getElementById('balanceUserId').textContent = 'Current Balance: ' + newBalance.toLocaleString() + ' SHB';
        document.getElementById('currentBalance').textContent = 'Current: ' + newBalance.toLocaleString() + ' SHB';
        
        // Clear the input
        document.getElementById('balanceAdjustment').value = '';
        
        // Refresh stats
        loadStats();
        
        // Close modal after a short delay
        setTimeout(() => {
          closeBalanceModal();
          // Refresh the balance control section
          document.getElementById('searchBalanceBtn').click();
        }, 1500);
        
      } catch (error) {
        showNotification('Error', error.message, 'error');
      }
    };

    // Tab Navigation
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
        
        // Load tab-specific data
        if (btn.dataset.tab === 'analytics') {
          updateAnalyticsCharts();
        }
        if (btn.dataset.tab === 'wallets') {
          loadWalletAddresses();
        }
      });
    });

    // Setup Image Uploads
    function setupImageUploads() {
      // Task Photo Upload
      const taskPhotoUpload = document.getElementById('taskPhotoUpload');
      const taskPhotoPreview = document.getElementById('taskPhotoPreview');
      const taskPhotoUrl = document.getElementById('taskPhoto');
      
      if (taskPhotoUpload) {
        taskPhotoUpload.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = function(e) {
            taskPhotoPreview.innerHTML = `<img src="${e.target.result}" alt="Task Photo">`;
            taskPhotoUrl.value = ''; // Clear URL input when file is selected
          };
          reader.readAsDataURL(file);
        });
      }
      
      if (taskPhotoUrl) {
        taskPhotoUrl.addEventListener('input', function() {
          if (this.value) {
            taskPhotoPreview.innerHTML = `<img src="${this.value}" alt="Task Photo" onerror="this.src='https://via.placeholder.com/150?text=Invalid+URL'">`;
            if (taskPhotoUpload) taskPhotoUpload.value = ''; // Clear file input when URL is entered
          }
        });
      }
      
      // Section Image Upload
      const sectionImageUpload = document.getElementById('sectionImageUpload');
      const sectionImagePreview = document.getElementById('sectionImagePreview');
      const sectionImageUrl = document.getElementById('sectionImage');
      
      if (sectionImageUpload) {
        sectionImageUpload.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = function(e) {
            sectionImagePreview.innerHTML = `<img src="${e.target.result}" alt="Section Image">`;
            sectionImageUrl.value = ''; // Clear URL input when file is selected
          };
          reader.readAsDataURL(file);
        });
      }
      
      if (sectionImageUrl) {
        sectionImageUrl.addEventListener('input', function() {
          if (this.value) {
            sectionImagePreview.innerHTML = `<img src="${this.value}" alt="Section Image" onerror="this.src='https://via.placeholder.com/150?text=Invalid+URL'">`;
            if (sectionImageUpload) sectionImageUpload.value = ''; // Clear file input when URL is entered
          }
        });
      }
      
      // Home Button Upload
      const homeButtonUpload = document.getElementById('homeButtonUpload');
      const homeButtonPreview = document.getElementById('homeButtonPreview');
      const homeButtonUrl = document.getElementById('homeButtonUrl');
      
      if (homeButtonUpload) {
        homeButtonUpload.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = function(e) {
            homeButtonPreview.innerHTML = `<img src="${e.target.result}" alt="Home Button">`;
            homeButtonUrl.value = ''; // Clear URL input when file is selected
          };
          reader.readAsDataURL(file);
        });
      }
      
      if (homeButtonUrl) {
        homeButtonUrl.addEventListener('input', function() {
          if (this.value) {
            homeButtonPreview.innerHTML = `<img src="${this.value}" alt="Home Button" onerror="this.src='https://via.placeholder.com/150?text=Invalid+URL'">`;
            if (homeButtonUpload) homeButtonUpload.value = ''; // Clear file input when URL is entered
          }
        });
      }
    }

    // Upload Image to Firebase Storage
    async function uploadImageToStorage(file, path) {
      return new Promise((resolve, reject) => {
        const storageRef = storage.ref();
        const imageRef = storageRef.child(path);
        
        const uploadTask = imageRef.put(file);
        
        uploadTask.on('state_changed', 
          (snapshot) => {
            // Progress function
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            console.log('Upload is ' + progress + '% done');
          }, 
          (error) => {
            // Error function
            reject(error);
          }, 
          () => {
            // Complete function
            uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
              resolve(downloadURL);
            });
          }
        );
      });
    }

    // Task Management
    document.getElementById('taskForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('taskName').value.trim();
      const link = document.getElementById('taskLink').value.trim();
      const amount = parseInt(document.getElementById('taskAmount').value);
      
      const btnText = document.getElementById('taskBtnText');
      btnText.innerHTML = '<div class="loading-spinner"></div>';
      
      try {
        let photoUrl = document.getElementById('taskPhoto').value.trim();
        
        // Check if a file was uploaded
        const photoUpload = document.getElementById('taskPhotoUpload');
        if (photoUpload && photoUpload.files.length > 0) {
          const file = photoUpload.files[0];
          const path = `tasks/${Date.now()}_${file.name}`;
          photoUrl = await uploadImageToStorage(file, path);
        }
        
        if (!photoUrl) {
          showNotification('Error', 'Please provide an image URL or upload an image', 'error');
          btnText.textContent = editingTaskId ? 'Update Task' : 'Add Task';
          return;
        }
        
        if (editingTaskId) {
          await db.ref('tasks/' + editingTaskId).update({ name, photo: photoUrl, link, amount });
          
          // Log the activity
          await db.ref('admin/activity').push({
            type: 'task_updated',
            taskId: editingTaskId,
            taskName: name,
            timestamp: Math.floor(Date.now() / 1000)
          });
          
          showNotification('Success', 'Task updated successfully!', 'success');
          editingTaskId = null;
          btnText.textContent = 'Add Task';
        } else {
          const taskId = Date.now().toString();
          await db.ref('tasks/' + taskId).set({ name, photo: photoUrl, link, amount });
          
          // Log the activity
          await db.ref('admin/activity').push({
            type: 'task_added',
            taskId: taskId,
            taskName: name,
            timestamp: Math.floor(Date.now() / 1000)
          });
          
          showNotification('Success', 'Task added successfully!', 'success');
          btnText.textContent = 'Add Task';
        }
        
        document.getElementById('taskForm').reset();
        document.getElementById('taskPhotoPreview').innerHTML = '<span>No image selected</span>';
        loadTasks();
      } catch (error) {
        showNotification('Error', error.message, 'error');
        btnText.textContent = editingTaskId ? 'Update Task' : 'Add Task';
      }
    });

    async function loadTasks() {
      try {
        const snapshot = await db.ref('tasks').once('value');
        const tasks = snapshot.val() || {};
        const tbody = document.getElementById('tasksTableBody');
        
        if (Object.keys(tasks).length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" style="text-align: center; padding: 40px;">
                <div class="empty-state">
                  <div class="empty-state-icon">üìã</div>
                  <div class="empty-state-text">No tasks yet. Add your first task!</div>
                </div>
              </td>
            </tr>
          `;
          return;
        }
        
        tbody.innerHTML = '';
        
        Object.entries(tasks).forEach(([taskId, task]) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><img src="${task.photo}" alt="${task.name}"></td>
            <td><strong>${task.name}</strong></td>
            <td><span class="badge badge-success">${task.amount} SHB</span></td>
            <td><a href="${task.link}" target="_blank" style="color: var(--accent);">View Link</a></td>
            <td>
              <div class="action-btns">
                <button class="btn btn-small btn-primary" onclick="editTask('${taskId}')">Edit</button>
                <button class="btn btn-small btn-danger" onclick="deleteTask('${taskId}')">Delete</button>
              </div>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (error) {
        console.error('Error loading tasks:', error);
      }
    }

    window.editTask = async (taskId) => {
      try {
        const snapshot = await db.ref('tasks/' + taskId).once('value');
        const task = snapshot.val();
        
        document.getElementById('taskName').value = task.name;
        document.getElementById('taskPhoto').value = task.photo;
        document.getElementById('taskLink').value = task.link;
        document.getElementById('taskAmount').value = task.amount;
        document.getElementById('taskPhotoPreview').innerHTML = `<img src="${task.photo}" alt="${task.name}">`;
        
        editingTaskId = taskId;
        document.getElementById('taskBtnText').textContent = 'Update Task';
        
        document.querySelector('[data-tab="tasks"]').click();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (error) {
        showNotification('Error', error.message, 'error');
      }
    };

    window.deleteTask = async (taskId) => {
      if (!confirm('Are you sure you want to delete this task?')) return;
      
      try {
        await db.ref('tasks/' + taskId).remove();
        
        // Log the activity
        await db.ref('admin/activity').push({
          type: 'task_deleted',
          taskId: taskId,
          timestamp: Math.floor(Date.now() / 1000)
        });
        
        showNotification('Success', 'Task deleted successfully!', 'success');
        loadTasks();
      } catch (error) {
        showNotification('Error', error.message, 'error');
      }
    };

    // User Management
    document.getElementById('searchUserBtn').addEventListener('click', async () => {
      const userIdOrUsername = document.getElementById('searchUserId').value.trim();
      
      if (!userIdOrUsername) {
        showNotification('Error', 'Please enter a user ID or Telegram username', 'error');
        return;
      }
      
      try {
        // First try to find by user ID
        let snapshot = await db.ref('users/' + userIdOrUsername).once('value');
        
        // If not found, try to find by Telegram username
        if (!snapshot.exists()) {
          const usersSnapshot = await db.ref('users').orderByChild('telegramUsername').equalTo(userIdOrUsername).once('value');
          
          if (usersSnapshot.numChildren() > 0) {
            usersSnapshot.forEach((childSnapshot) => {
              snapshot = childSnapshot;
            });
          } else {
            showNotification('Error', 'User not found', 'error');
            document.getElementById('userInfoContainer').innerHTML = '';
            return;
          }
        }
        
        const userId = snapshot.key;
        const user = snapshot.val();
        
        const telegramInfo = user.telegramUsername ? 
          `<div class="telegram-info">
            <span class="telegram-icon">üì±</span>
            <span>@${user.telegramUsername}</span>
          </div>` : '';
        
        const deviceInfo = user.deviceInfo ? 
          `<div class="device-info-pill">${user.deviceInfo.type || 'Unknown'}</div>
           <div class="device-info-pill">${user.deviceInfo.os || 'Unknown OS'}</div>
           <div class="device-info-pill">${user.deviceInfo.browser || 'Unknown Browser'}</div>` : '';
        
        const locationInfo = user.location ? 
          `<div class="device-info-pill">
            <img src="https://flagcdn.com/w20/${getCountryCode(user.location.country || 'Unknown').toLowerCase()}.png" class="country-flag" alt="${user.location.country || 'Unknown'}">
            ${user.location.country || 'Unknown'}
          </div>
          <div class="device-info-pill">${user.location.city || 'Unknown City'}</div>` : '';
        
        const isOnline = user.lastSeen && (Math.floor(Date.now() / 1000) - user.lastSeen < 300);
        const statusIndicator = `<span class="online-indicator ${isOnline ? 'online' : 'offline'}"></span>`;
        
        // Calculate uptime
        const createdAt = user.createdAt || Math.floor(Date.now() / 1000);
        const accountAge = Math.floor((Date.now() / 1000) - createdAt);
        const days = Math.floor(accountAge / 86400);
        const hours = Math.floor((accountAge % 86400) / 3600);
        const uptime = `${days} days, ${hours} hours`;
        
        document.getElementById('userInfoContainer').innerHTML = `
          <div class="user-info-card">
            <h3 style="margin-bottom: 15px;">User Details ${statusIndicator} ${isOnline ? 'Online' : 'Offline'}</h3>
            <div style="margin-bottom: 10px;">${telegramInfo}</div>
            <div class="user-info-grid">
              <div class="user-info-item">
                <div class="user-info-label">User ID</div>
                <div class="user-info-value">${userId}</div>
              </div>
              <div class="user-info-item">
                <div class="user-info-label">Balance</div>
                <div class="user-info-value">${(user.balance || 0).toLocaleString()} SHB</div>
              </div>
              <div class="user-info-item">
                <div class="user-info-label">Energy</div>
                <div class="user-info-value">${user.energy || 0} / ${user.maxEnergy || 1200}</div>
              </div>
              <div class="user-info-item">
                <div class="user-info-label">Multi Tap</div>
                <div class="user-info-value">${user.multiTap || 1}</div>
              </div>
              <div class="user-info-item">
                <div class="user-info-label">Referrals</div>
                <div class="user-info-value">${user.referrals || 0}</div>
              </div>
              <div class="user-info-item">
                <div class="user-info-label">Account Age</div>
                <div class="user-info-value">${uptime}</div>
              </div>
              <div class="user-info-item">
                <div class="user-info-label">TON Wallet</div>
                <div class="user-info-value" style="font-size: 0.8rem; word-break: break-all;">${user.ton || 'Not set'}</div>
              </div>
              <div class="user-info-item">
                <div class="user-info-label">IP Address</div>
                <div class="user-info-value">${user.ipAddress || 'Unknown'}</div>
              </div>
            </div>
            <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 5px;">
              ${deviceInfo}
              ${locationInfo}
            </div>
            <div style="margin-top: 15px;">
              <button class="btn btn-primary" onclick="openBalanceModal('${userId}', '${user.balance || 0}')">
                Adjust Balance
              </button>
            </div>
          </div>
          
          <div class="card" style="margin-top: 20px;">
            <div class="card-header">
              <h3 class="card-title">User Activity Log</h3>
            </div>
            <div class="user-activity-log" id="userActivityLog">
              <div class="activity-item">
                <span class="activity-action">Loading activity data...</span>
                <span class="activity-time"></span>
              </div>
            </div>
          </div>
        `;
        
        // Load user activity
        loadUserActivity(userId);
      } catch (error) {
        showNotification('Error', error.message, 'error');
      }
    });

    async function loadUserActivity(userId) {
      try {
        const activityLog = document.getElementById('userActivityLog');
        if (!activityLog) return;
        
        const snapshot = await db.ref('users/' + userId + '/activity').orderByChild('timestamp').limitToLast(20).once('value');
        const activities = snapshot.val() || {};
        
        if (Object.keys(activities).length === 0) {
          activityLog.innerHTML = `
            <div class="activity-item">
              <span class="activity-action">No activity recorded for this user</span>
              <span class="activity-time"></span>
            </div>
          `;
          return;
        }
        
        activityLog.innerHTML = '';
        
        // Convert to array and sort by timestamp (newest first)
        const activitiesArray = Object.entries(activities).map(([id, activity]) => ({
          id,
          ...activity
        })).sort((a, b) => b.timestamp - a.timestamp);
        
        activitiesArray.forEach(activity => {
          const time = new Date(activity.timestamp * 1000);
          const timeString = time.toLocaleString();
          
          let actionText = 'Unknown action';
          
          switch (activity.type) {
            case 'login':
              actionText = 'User logged in';
              break;
            case 'balance_change':
              actionText = `Balance ${activity.change > 0 ? 'increased' : 'decreased'} by ${Math.abs(activity.change)} SHB`;
              break;
            case 'task_completed':
              actionText = `Completed task: ${activity.taskName || 'Unknown task'}`;
              break;
            case 'ad_watched':
              actionText = 'Watched an advertisement';
              break;
            case 'referral_added':
              actionText = 'Referred a new user';
              break;
            case 'wallet_updated':
              actionText = 'Updated TON wallet address';
              break;
            default:
              actionText = activity.type || 'Unknown action';
          }
          
          const activityItem = document.createElement('div');
          activityItem.className = 'activity-item';
          activityItem.innerHTML = `
            <span class="activity-action">${actionText}</span>
            <span class="activity-time">${timeString}</span>
          `;
          
          activityLog.appendChild(activityItem);
        });
      } catch (error) {
        console.error('Error loading user activity:', error);
      }
    }

    async function loadUsers() {
      try {
        const snapshot = await db.ref('users').limitToFirst(50).once('value');
        const users = snapshot.val() || {};
        const tbody = document.getElementById('usersTableBody');
        
        if (Object.keys(users).length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center; padding: 40px;">
                <div class="empty-state">
                  <div class="empty-state-icon">üë•</div>
                  <div class="empty-state-text">No users yet</div>
                </div>
              </td>
            </tr>
          `;
          return;
        }
        
        tbody.innerHTML = '';
        
        const now = Math.floor(Date.now() / 1000);
        
        Object.entries(users).forEach(([userId, user]) => {
          const isOnline = user.lastSeen && (now - user.lastSeen < 300);
          const statusIndicator = `<span class="online-indicator ${isOnline ? 'online' : 'offline'}"></span>`;
          
          const telegramUsername = user.telegramUsername ? 
            `<div class="telegram-info">
              <span class="telegram-icon">üì±</span>
              <span>@${user.telegramUsername}</span>
            </div>` : 'Not linked';
          
          const deviceInfo = user.deviceInfo ? 
            `<div class="device-info-pill">${user.deviceInfo.type || 'Unknown'}</div>` : 
            '<div class="device-info-pill">Unknown</div>';
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><strong>${userId}</strong></td>
            <td>${telegramUsername}</td>
            <td><span class="badge badge-success">${(user.balance || 0).toLocaleString()} SHB</span></td>
            <td>${statusIndicator} ${isOnline ? 'Online' : 'Offline'}</td>
            <td>${deviceInfo}</td>
            <td>
              <button class="btn btn-small btn-primary" onclick="viewUser('${userId}')">View</button>
              <button class="btn btn-small btn-success" onclick="openBalanceModal('${userId}', '${user.balance || 0}')">Balance</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    window.viewUser = (userId) => {
      document.getElementById('searchUserId').value = userId;
      document.querySelector('[data-tab="users"]').click();
      document.getElementById('searchUserBtn').click();
    };

    // Profile Sections Management
    document.getElementById('profileSectionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('sectionName').value.trim();
      const link = document.getElementById('sectionLink').value.trim();
      
      const btnText = document.getElementById('sectionBtnText');
      btnText.innerHTML = '<div class="loading-spinner"></div>';
      
      try {
        let imageUrl = document.getElementById('sectionImage').value.trim();
        
        // Check if a file was uploaded
        const imageUpload = document.getElementById('sectionImageUpload');
        if (imageUpload && imageUpload.files.length > 0) {
          const file = imageUpload.files[0];
          const path = `sections/${Date.now()}_${file.name}`;
          imageUrl = await uploadImageToStorage(file, path);
        }
        
        if (!imageUrl) {
          showNotification('Error', 'Please provide an image URL or upload an image', 'error');
          btnText.textContent = editingSectionId ? 'Update Section' : 'Add Section';
          return;
        }
        
        if (editingSectionId) {
          await db.ref('profileSections/' + editingSectionId).update({ name, image: imageUrl, link });
          
          // Log the activity
          await db.ref('admin/activity').push({
            type: 'section_updated',
            sectionId: editingSectionId,
            sectionName: name,
            timestamp: Math.floor(Date.now() / 1000)
          });
          
          showNotification('Success', 'Section updated successfully!', 'success');
          editingSectionId = null;
          btnText.textContent = 'Add Section';
        } else {
          const sectionId = name.toLowerCase().replace(/\s+/g, '_');
          await db.ref('profileSections/' + sectionId).set({ name, image: imageUrl, link });
          
          // Log the activity
          await db.ref('admin/activity').push({
            type: 'section_added',
            sectionId: sectionId,
            sectionName: name,
            timestamp: Math.floor(Date.now() / 1000)
          });
          
          showNotification('Success', 'Section added successfully!', 'success');
          btnText.textContent = 'Add Section';
        }
        
        document.getElementById('profileSectionForm').reset();
        document.getElementById('sectionImagePreview').innerHTML = '<span>No image selected</span>';
        loadProfileSections();
      } catch (error) {
        showNotification('Error', error.message, 'error');
        btnText.textContent = editingSectionId ? 'Update Section' : 'Add Section';
      }
    });

    async function loadProfileSections() {
      try {
        const snapshot = await db.ref('profileSections').once('value');
        const sections = snapshot.val() || {};
        const container = document.getElementById('profileSectionsContainer');
        
        if (!container) return;
        
        const count = Object.keys(sections).length;
        const sectionCount = document.getElementById('sectionCount');
        if (sectionCount) sectionCount.textContent = `${count} Sections`;
        
        if (count === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üéØ</div>
              <div class="empty-state-text">No sections yet. Add your first section!</div>
            </div>
          `;
          return;
        }
        
        container.innerHTML = '';
        
        Object.entries(sections).forEach(([sectionId, section]) => {
          const item = document.createElement('div');
          item.className = 'profile-section-item';
          item.innerHTML = `
            <img src="${section.image}" alt="${section.name}">
            <div class="profile-section-name">${section.name}</div>
            <div class="profile-section-link">${section.link}</div>
            <div class="action-btns" style="margin-top: 10px;">
              <button class="btn btn-small btn-primary" onclick="editSection('${sectionId}')">Edit</button>
              <button class="btn btn-small btn-danger" onclick="deleteSection('${sectionId}')">Delete</button>
            </div>
          `;
          container.appendChild(item);
        });
      } catch (error) {
        console.error('Error loading profile sections:', error);
      }
    }

    window.editSection = async (sectionId) => {
      try {
        const snapshot = await db.ref('profileSections/' + sectionId).once('value');
        const section = snapshot.val();
        
        document.getElementById('sectionName').value = section.name;
        document.getElementById('sectionImage').value = section.image;
        document.getElementById('sectionLink').value = section.link;
        document.getElementById('sectionImagePreview').innerHTML = `<img src="${section.image}" alt="${section.name}">`;
        
        editingSectionId = sectionId;
        document.getElementById('sectionBtnText').textContent = 'Update Section';
        
        document.querySelector('[data-tab="profile-sections"]').click();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (error) {
        showNotification('Error', error.message, 'error');
      }
    };

    window.deleteSection = async (sectionId) => {
      if (!confirm('Are you sure you want to delete this section?')) return;
      
      try {
        await db.ref('profileSections/' + sectionId).remove();
        
        // Log the activity
        await db.ref('admin/activity').push({
          type: 'section_deleted',
          sectionId: sectionId,
          timestamp: Math.floor(Date.now() / 1000)
        });
        
        showNotification('Success', 'Section deleted successfully!', 'success');
        loadProfileSections();
      } catch (error) {
        showNotification('Error', error.message, 'error');
      }
    };

    // Redeem Codes Management
    document.getElementById('redeemForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const code = document.getElementById('redeemCode').value.trim();
      
      if (code.length !== 4 || !/^\d+$/.test(code)) {
        showNotification('Error', 'Code must be 4 digits', 'error');
        return;
      }
      
      try {
        await db.ref('redeemCodes/' + code).set(true);
        
        // Log the activity
        await db.ref('admin/activity').push({
          type: 'redeem_code_generated',
          code: code,
          timestamp: Math.floor(Date.now() / 1000)
        });
        
        showNotification('Success', 'Redeem code generated!', 'success');
        document.getElementById('redeemForm').reset();
        loadRedeemCodes();
      } catch (error) {
        showNotification('Error', error.message, 'error');
      }
    });

    async function loadRedeemCodes() {
      try {
        const snapshot = await db.ref('redeemCodes').once('value');
        const codes = snapshot.val() || {};
        const tbody = document.getElementById('redeemTableBody');
        
        if (!tbody) return;
        
        const count = Object.keys(codes).length;
        const redeemCount = document.getElementById('redeemCount');
        if (redeemCount) redeemCount.textContent = `${count} Codes`;
        
        if (count === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="3" style="text-align: center; padding: 40px;">
                <div class="empty-state">
                  <div class="empty-state-icon">üéÅ</div>
                  <div class="empty-state-text">No redeem codes yet</div>
                </div>
              </td>
            </tr>
          `;
          return;
        }
        
        tbody.innerHTML = '';
        
        Object.keys(codes).forEach(code => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><strong style="font-size: 1.2rem; letter-spacing: 2px;">${code}</strong></td>
            <td><span class="badge badge-success">Active</span></td>
            <td>
              <button class="btn btn-small btn-danger" onclick="deleteRedeemCode('${code}')">Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (error) {
        console.error('Error loading redeem codes:', error);
      }
    }

    window.deleteRedeemCode = async (code) => {
      if (!confirm('Are you sure you want to delete this code?')) return;
      
      try {
        await db.ref('redeemCodes/' + code).remove();
        
        // Log the activity
        await db.ref('admin/activity').push({
          type: 'redeem_code_deleted',
          code: code,
          timestamp: Math.floor(Date.now() / 1000)
        });
        
        showNotification('Success', 'Code deleted successfully!', 'success');
        loadRedeemCodes();
      } catch (error) {
        showNotification('Error', error.message, 'error');
      }
    };

    // Wallet Addresses Management
    async function loadWalletAddresses() {
      try {
        const snapshot = await db.ref('users').orderByChild('ton').startAt('').once('value');
        const users = snapshot.val() || {};
        const tbody = document.getElementById('walletsTableBody');
        
        if (!tbody) return;
        
        walletAddresses = [];
        
        Object.entries(users).forEach(([userId, user]) => {
          if (user.ton && user.ton.trim() !== '') {
            walletAddresses.push({
              userId: userId,
              telegramUsername: user.telegramUsername || '',
              telegramName: (user.telegramFirstName || '') + ' ' + (user.telegramLastName || ''),
              wallet: user.ton,
              balance: user.balance || 0
            });
          }
        });
        
        if (walletAddresses.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" style="text-align: center; padding: 40px;">
                <div class="empty-state">
                  <div class="empty-state-icon">üíº</div>
                  <div class="empty-state-text">No wallet addresses found</div>
                </div>
              </td>
            </tr>
          `;
          return;
        }
        
        tbody.innerHTML = '';
        
        walletAddresses.forEach(item => {
          const row = document.createElement('tr');
          
          const telegramInfo = item.telegramUsername ? 
            `<div class="telegram-info">
              <span class="telegram-icon">üì±</span>
              <span>@${item.telegramUsername}</span>
            </div>` : 
            (item.telegramName ? item.telegramName : 'Not linked');
          
          row.innerHTML = `
            <td>${item.userId}</td>
            <td>${telegramInfo}</td>
            <td class="wallet-address">${item.wallet}</td>
            <td class="wallet-balance">${item.balance.toLocaleString()} SHB</td>
            <td>
              <button class="copy-btn" onclick="copyWalletAddress('${item.wallet}')">Copy</button>
              <button class="btn btn-small btn-primary" onclick="viewUser('${item.userId}')">View User</button>
            </td>
          `;
          tbody.appendChild(row);
        });
        
        // Setup export button
        document.getElementById('exportWallets').addEventListener('click', exportWalletAddresses);
      } catch (error) {
        console.error('Error loading wallet addresses:', error);
      }
    }

    window.copyWalletAddress = (address) => {
      navigator.clipboard.writeText(address).then(() => {
        showNotification('Success', 'Wallet address copied to clipboard!', 'success');
      }).catch(err => {
        showNotification('Error', 'Failed to copy address: ' + err, 'error');
      });
    };

    function exportWalletAddresses() {
      if (walletAddresses.length === 0) {
        showNotification('Error', 'No wallet addresses to export', 'error');
        return;
      }
      
      let content = 'User ID,Telegram,Wallet Address,Balance\n';
      
      walletAddresses.forEach(item => {
        const telegram = item.telegramUsername ? '@' + item.telegramUsername : (item.telegramName || 'Not linked');
        content += `${item.userId},${telegram},${item.wallet},${item.balance}\n`;
      });
      
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      saveAs(blob, 'wallet_addresses.txt');
      
      showNotification('Success', 'Wallet addresses exported successfully!', 'success');
    }

    // UI Customization
    document.getElementById('saveColorScheme').addEventListener('click', async () => {
      const primaryColor = document.getElementById('primaryColor').value;
      const secondaryColor = document.getElementById('secondaryColor').value;
      const bgColorStart = document.getElementById('bgColorStart').value;
      const bgColorEnd = document.getElementById('bgColorEnd').value;
      
      try {
        await db.ref('appSettings/colors').set({
          primary: primaryColor,
          secondary: secondaryColor,
          bgStart: bgColorStart,
          bgEnd: bgColorEnd,
          updatedAt: Math.floor(Date.now() / 1000)
        });
        
        // Log the activity
        await db.ref('admin/activity').push({
          type: 'ui_colors_updated',
          timestamp: Math.floor(Date.now() / 1000)
        });
        
        showNotification('Success', 'Color scheme saved successfully!', 'success');
      } catch (error) {
        showNotification('Error', error.message, 'error');
      }
    });

    document.getElementById('saveHomeButton').addEventListener('click', async () => {
      const homeButtonUrl = document.getElementById('homeButtonUrl').value.trim();
      const homeButtonUpload = document.getElementById('homeButtonUpload');
      
      try {
        let imageUrl = homeButtonUrl;
        
        // Check if a file was uploaded
        if (homeButtonUpload && homeButtonUpload.files.length > 0) {
          const file = homeButtonUpload.files[0];
          const path = `ui/home_button_${Date.now()}.png`;
          imageUrl = await uploadImageToStorage(file, path);
        }
        
        if (!imageUrl) {
          showNotification('Error', 'Please provide an image URL or upload an image', 'error');
          return;
        }
        
        await db.ref('appSettings/buttons').set({
          home: imageUrl,
          updatedAt: Math.floor(Date.now() / 1000)
        });
        
        // Log the activity
        await db.ref('admin/activity').push({
          type: 'ui_button_updated',
          button: 'home',
          timestamp: Math.floor(Date.now() / 1000)
        });
        
        showNotification('Success', 'Home button updated successfully!', 'success');
      } catch (error) {
        showNotification('Error', error.message, 'error');
      }
    });

    // Charts
    function initializeCharts() {
      // Overview Chart
      const overviewCtx = document.getElementById('overviewChart');
      if (overviewCtx) {
        new Chart(overviewCtx.getContext('2d'), {
          type: 'line',
          data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
              label: 'Users',
              data: [12, 19, 15, 25, 22, 30, 35],
              borderColor: '#27cdfc',
              backgroundColor: 'rgba(39, 205, 252, 0.1)',
              tension: 0.4
            }, {
              label: 'Tasks Completed',
              data: [8, 15, 12, 20, 18, 25, 28],
              borderColor: '#ff61a6',
              backgroundColor: 'rgba(255, 97, 166, 0.1)',
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'top',
              }
            }
          }
        });
      }
      
      // Load recent activity
      loadRecentActivity();
    }

    async function loadRecentActivity() {
      try {
        const activityContainer = document.getElementById('recentActivity');
        if (!activityContainer) return;
        
        const snapshot = await db.ref('admin/activity').orderByChild('timestamp').limitToLast(10).once('value');
        const activities = snapshot.val() || {};
        
        if (Object.keys(activities).length === 0) {
          activityContainer.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìä</div>
              <div class="empty-state-text">No activity recorded yet</div>
            </div>
          `;
          return;
        }
        
        // Convert to array and sort by timestamp (newest first)
        const activitiesArray = Object.entries(activities).map(([id, activity]) => ({
          id,
          ...activity
        })).sort((a, b) => b.timestamp - a.timestamp);
        
        let html = '<div class="user-activity-log">';
        
        activitiesArray.forEach(activity => {
          const time = new Date(activity.timestamp * 1000);
          const timeString = time.toLocaleString();
          
          let actionText = 'Unknown action';
          
          switch (activity.type) {
            case 'balance_adjustment':
              actionText = `Balance ${activity.adjustment > 0 ? 'increased' : 'decreased'} for user ${activity.userId} by ${Math.abs(activity.adjustment)} SHB`;
              break;
            case 'task_added':
              actionText = `New task added: ${activity.taskName || 'Unknown task'}`;
              break;
            case 'task_updated':
              actionText = `Task updated: ${activity.taskName || 'Unknown task'}`;
              break;
            case 'task_deleted':
              actionText = `Task deleted: ${activity.taskId}`;
              break;
            case 'section_added':
              actionText = `New profile section added: ${activity.sectionName || 'Unknown section'}`;
              break;
            case 'section_updated':
              actionText = `Profile section updated: ${activity.sectionName || 'Unknown section'}`;
              break;
            case 'section_deleted':
              actionText = `Profile section deleted: ${activity.sectionId}`;
              break;
            case 'redeem_code_generated':
              actionText = `Redeem code generated: ${activity.code}`;
              break;
            case 'redeem_code_deleted':
              actionText = `Redeem code deleted: ${activity.code}`;
              break;
            case 'ui_colors_updated':
              actionText = 'UI color scheme updated';
              break;
            case 'ui_button_updated':
              actionText = `UI button updated: ${activity.button}`;
              break;
            default:
              actionText = activity.type || 'Unknown action';
          }
          
          html += `
            <div class="activity-item">
              <span class="activity-action">${actionText}</span>
              <span class="activity-time">${timeString}</span>
            </div>
          `;
        });
        
        html += '</div>';
        activityContainer.innerHTML = html;
      } catch (error) {
        console.error('Error loading recent activity:', error);
      }
    }

    function updateAnalyticsCharts() {
      // User Growth Chart
      const userGrowthCtx = document.getElementById('userGrowthChart');
      if (userGrowthCtx) {
        new Chart(userGrowthCtx.getContext('2d'), {
          type: 'bar',
          data: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
            datasets: [{
              label: 'New Users',
              data: [45, 67, 89, 112],
              backgroundColor: 'rgba(39, 205, 252, 0.8)',
              borderColor: '#27cdfc',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      }

      // Balance Chart
      const balanceCtx = document.getElementById('balanceChart');
      if (balanceCtx) {
        new Chart(balanceCtx.getContext('2d'), {
          type: 'doughnut',
          data: {
            labels: ['0-1000 SHB', '1000-5000 SHB', '5000-10000 SHB', '10000+ SHB'],
            datasets: [{
              data: [30, 40, 20, 10],
              backgroundColor: [
                'rgba(39, 205, 252, 0.8)',
                'rgba(255, 97, 166, 0.8)',
                'rgba(255, 210, 62, 0.8)',
                'rgba(52, 211, 153, 0.8)'
              ],
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }
      
      // Device Chart
      const deviceCtx = document.getElementById('deviceChart');
      if (deviceCtx) {
        const deviceLabels = Object.keys(userDeviceData);
        const deviceData = Object.values(userDeviceData);
        
        new Chart(deviceCtx.getContext('2d'), {
          type: 'pie',
          data: {
            labels: deviceLabels.length > 0 ? deviceLabels : ['No data'],
            datasets: [{
              data: deviceData.length > 0 ? deviceData : [1],
              backgroundColor: [
                'rgba(39, 205, 252, 0.8)',
                'rgba(255, 97, 166, 0.8)',
                'rgba(255, 210, 62, 0.8)',
                'rgba(52, 211, 153, 0.8)',
                'rgba(99, 102, 241, 0.8)',
                'rgba(245, 158, 11, 0.8)'
              ],
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }
      
      // Activity Chart
      const activityCtx = document.getElementById('activityChart');
      if (activityCtx) {
        new Chart(activityCtx.getContext('2d'), {
          type: 'line',
          data: {
            labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
            datasets: [{
              label: 'Active Users',
              data: [5, 2, 10, 15, 25, 20],
              borderColor: '#ff61a6',
              backgroundColor: 'rgba(255, 97, 166, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              title: {
                display: true,
                text: 'User Activity by Hour (UTC)'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Active Users'
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'Time (UTC)'
                }
              }
            }
          }
        });
      }
    }

    // Initialize on load
    initializeDashboard();
  </script>
</body>
</html>
