<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shark Bounty</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="icon" type="image/png" href="17510103.gif">
  <!-- Firebase Web SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js"></script>
  <style>
    /* ... all your previous CSS unchanged ... */
    /* (keep existing styles from index_Version5.html) */
  </style>
</head>
<body>
  <!-- LOADING SCREEN -->
  <div id="loading-screen">
    <video src="29f4182c-fb84-4f6e-830f-f560ae571afe.mp4" autoplay muted playsinline loop></video>
  </div>
  <!-- Dynamic Island Notification -->
  <div id="dynamic-island"></div>
  <div id="app">
    <!-- Top Bar -->
    <div class="top-bar" id="top-bar">
      <span id="main-title">Shark Bounty</span>
    </div>
    <!-- BALANCE -->
    <div style="margin: 0 17px 10px 17px;">
      <div class="balance-row">
        <div class="balance-coin"><img src="17510103.gif"/><span class="coin-txt">SHB</span> <span id="shb-balance" class="coin-amt">0</span></div>
        <div class="balance-usdt"><img src="15207964.png"/><span class="usdt-txt">USDT</span> <span id="usdt-balance" class="usdt-amt">0.00</span></div>
      </div>
    </div>
    <!-- HOME UI -->
    <div id="home-ui" style="position:relative;">
      <div class="coin-tapper-outer">
        <div class="coin-tapper" id="coin-tapper">
          <img src="17510103.gif" alt="Shark Coin"/>
          <span class="tap-plus-anim" id="tap-plus-anim"></span>
        </div>
        <div class="energy-bar-outer">
          <div class="energy-bar-inner" id="energy-bar-inner"></div>
          <div class="energy-label" id="energy-label">Energy: 1200</div>
          <img src="934817.png" class="energy-bar-icon" alt="Energy"/>
        </div>
      </div>
      <div class="home-float-btn" id="home-float-btns">
        <button onclick="showProfileModal('dci')" title="Daily Check In"><img src="1142792.png"/><span>Check In</span></button>
        <button onclick="showProfileModal('redeem')" title="Redeem"><img src="3179668.png"/><span>Redeem</span></button>
      </div>
    </div>
    <!-- TRADE UI -->
    <div id="trade-ui">
      <div class="plans-list" id="plans-list"></div>
    </div>
    <!-- TASKS UI -->
    <div id="tasks-ui"></div>
    <!-- WALLET UI -->
    <div id="wallet-ui">
      <div class="wallet-tabs">
        <button class="wallet-tab" id="deposit-tab">Deposit</button>
        <button class="wallet-tab" id="withdraw-tab">Withdraw</button>
        <button class="wallet-tab" id="history-tab">History</button>
      </div>
      <div class="wallet-section" id="deposit-section"></div>
      <div class="wallet-section" id="withdraw-section"></div>
      <div class="history-list" id="history-section"></div>
    </div>
    <!-- PROFILE UI -->
    <div id="profile-ui">
      <div class="profile-card">
        <img src="18827926.png" class="profile-avatar"/>
        <div class="profile-row"><span class="profile-label">Username:</span><span class="profile-val" id="profile-username">SharkUser</span></div>
        <div class="profile-row"><span class="profile-label">Referral:</span><span class="profile-val" id="profile-referral">None</span></div>
        <div class="profile-row"><span class="profile-label">Joined:</span><span class="profile-val" id="profile-joined"></span></div>
        <div class="profile-id-row"><span class="profile-id-label">User ID:</span><span class="profile-id-value" id="profile-userid"></span>
          <button class="copy-btn" onclick="copy(document.getElementById('profile-userid').textContent)" title="Copy User ID"><img src="1622069.png"></button>
        </div>
        <div class="profile-actions">
          <button class="profile-action-btn" onclick="showProfileModal('referral')"><img src="17675714.png">Referrals</button>
          <button class="profile-action-btn" onclick="showProfileModal('leaderboard')"><img src="19026492.png">Leaderboard</button>
          <button class="profile-action-btn" onclick="showProfileModal('notification')"><img src="13146658.png">Notification</button>
        </div>
      </div>
    </div>
    <!-- BOTTOM NAV -->
    <div class="bottom-nav" id="bottom-nav">
      <button class="nav-btn active" data-nav="home"><img src="1057118.png"/><span>Home</span></button>
      <button class="nav-btn" data-nav="trade"><img src="9084248.png"/><span>Trade</span></button>
      <button class="nav-btn" data-nav="tasks"><img src="16104409.png"/><span>Tasks</span></button>
      <button class="nav-btn" data-nav="wallet"><img src="6826311.png"/><span>Wallet</span></button>
      <button class="nav-btn" data-nav="profile"><img src="18827926.png"/><span>Profile</span></button>
    </div>
    <!-- MODALS / REDEEM PAGE -->
    <div id="profile-modal-anchor"></div>
    <div id="redeem-page"></div>
  </div>
  <script>
    // ---- Firebase Web SDK Setup ----
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "shark-bounty.firebaseapp.com",
      databaseURL: "https://shark-bounty-default-rtdb.firebaseio.com",
      projectId: "shark-bounty",
      storageBucket: "shark-bounty.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // ---- User Authentication (Anonymous for simplicity) ----
    let currentUser = null;
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        initAppData();
      } else {
        auth.signInAnonymously();
      }
    });

    // ---- App Logic ----
    // Helper: Get User ID (from Firebase Auth)
    function getUserId() {
      return currentUser ? currentUser.uid : null;
    }

    // Helper: Write user data to DB
    function setUserData(data) {
      const uid = getUserId();
      if (!uid) return;
      return db.ref('users/' + uid).set(data);
    }

    // Helper: Update user field(s)
    function updateUserData(upd) {
      const uid = getUserId();
      if (!uid) return;
      return db.ref('users/' + uid).update(upd);
    }

    // Helper: Get user data from DB
    function fetchUserData() {
      const uid = getUserId();
      if (!uid) return Promise.resolve({});
      return db.ref('users/' + uid).once('value').then(snap => snap.val() || {});
    }

    // ---- Initial Data Load ----
    let userData = {};
    function initAppData() {
      fetchUserData().then(data => {
        userData = data || {};
        if (!userData.userid) userData.userid = getUserId();
        if (!userData.shb) userData.shb = 0;
        if (!userData.usdt) userData.usdt = 0;
        if (!userData.energy) userData.energy = 1200;
        if (!userData.lastEnergyTs) userData.lastEnergyTs = Date.now();
        if (!userData.history) userData.history = [];
        if (!userData.notifications) userData.notifications = [];
        if (!userData.dci) userData.dci = { last: null, streak: 0, progress: [false,false,false,false,false,false,false] };
        if (!userData.tasks) userData.tasks = {};
        if (!userData.redeem) userData.redeem = [];
        setUserData(userData);
        bindRealtimeUpdates();
        renderAll();
      });
    }

    // ---- Real-time Updates ----
    function bindRealtimeUpdates() {
      const uid = getUserId();
      // User balance, history, notifications
      db.ref('users/' + uid).on('value', snap => {
        userData = snap.val() || userData;
        renderAll();
      });
      // Global notifications
      db.ref('notifications/global').on('value', snap => {
        userData.globalNotifications = snap.val() || [];
        renderProfileNotifications();
      });
      // Tasks
      db.ref('tasks').on('value', snap => {
        userData.availableTasks = snap.val() || {};
        renderTasks();
      });
    }

    // ---- UI Renderers ----
    function renderAll() {
      updateBalances();
      updateEnergyBar();
      renderPlans();
      renderHistory();
      renderProfile();
      renderProfileNotifications();
      renderTasks();
      document.getElementById('profile-userid').textContent = userData.userid;
      document.getElementById('profile-joined').textContent = userData.joinedDate || (new Date()).toISOString().slice(0,10);
    }

    function updateBalances() {
      document.getElementById('shb-balance').textContent = userData.shb || 0;
      document.getElementById('usdt-balance').textContent = parseFloat(userData.usdt||0).toFixed(2);
    }

    // ---- Energy Bar ----
    function updateEnergyBar() {
      let now = Date.now();
      let diff = Math.floor((now - (userData.lastEnergyTs||0))/1000);
      let energy = userData.energy||1200;
      if (energy<1200 && diff>0) {
        energy += diff;
        if (energy>1200) energy=1200;
        userData.energy = energy;
        userData.lastEnergyTs = now;
        updateUserData({ energy, lastEnergyTs: now });
      }
      let perc = Math.floor(energy/1200*100);
      document.getElementById('energy-bar-inner').style.width = perc+"%";
      document.getElementById('energy-label').textContent = "Energy: "+energy;
    }
    setInterval(updateEnergyBar, 1000);

    // ---- Coin Tapper ----
    const tapper = document.getElementById('coin-tapper');
    tapper.addEventListener('mousedown', function(e){
      if (e.button!==0) return;
      tapCoin(1);
    });
    tapper.addEventListener('touchstart', function(e){
      tapCoin(e.touches.length);
      e.preventDefault();
    }, {passive: false});
    function tapCoin(count) {
      let energy = userData.energy||1200;
      let gain = 0;
      for (let i=0;i<count;i++) {
        if (energy > 0) {
          gain++;
          energy--;
        }
      }
      if (gain>0) {
        userData.shb = (userData.shb||0) + gain;
        userData.energy = energy;
        userData.lastEnergyTs = Date.now();
        updateUserData({ shb: userData.shb, energy, lastEnergyTs: userData.lastEnergyTs });
        showTapAnim("+"+gain);
      } else {
        showTapAnim("<span style='color:#ff556b'>No Energy!</span>");
      }
      updateBalances();
      updateEnergyBar();
    }
    function showTapAnim(txt){
      let anim = document.getElementById('tap-plus-anim');
      anim.innerHTML = txt;
      anim.style.opacity=1;
      anim.style.animation = 'none'; anim.offsetHeight; anim.style.animation = null;
      setTimeout(()=>{anim.style.opacity=0},700);
    }

    // ---- Trade Plans ----
    const PLANS = [
      { id:'ton', name:'TON/USDT', price:10, validity:30, daily:1, img:'1142792.png' },
      { id:'not', name:'NOT/USDT', price:30, validity:30, daily:3, img:'1142792.png' },
      { id:'hmstr', name:'HMSTR/USDT', price:70, validity:30, daily:7, img:'1142792.png' },
      { id:'eth', name:'ETH/USDT', price:100, validity:30, daily:10, img:'1142792.png' },
      { id:'bnb', name:'BNB/USDT', price:150, validity:30, daily:15, img:'1142792.png' },
      { id:'btc', name:'BTC/USDT', price:200, validity:30, daily:20, img:'1142792.png' }
    ];
    function renderPlans() {
      let plansEl = document.getElementById('plans-list');
      plansEl.innerHTML = '';
      PLANS.forEach(plan=>{
        let userPlan = userData.plans ? userData.plans[plan.id] : {};
        let active = !!(userPlan && userPlan.purchased);
        let canClaim = active && Date.now() - (userPlan.lastClaim||0) > 24*3600*1000;
        let expired = active && Date.now() > userPlan.purchased + plan.validity*24*3600*1000;
        let btnTxt = !active ? 'Buy' : (canClaim ? 'Claim' : 'Claimed');
        let disabled = active && !canClaim;
        let row = document.createElement('div');
        row.className = 'plan-card';
        row.innerHTML = `
          <div class="plan-title">
            ${plan.name}
            <img src="2592317.png" class="plan-secure" title="Secure"/>
          </div>
          <div class="plan-row">
            <span class="plan-price"><img src="15207964.png" style="width:18px;vertical-align:middle;margin-right:2px;">$${plan.price}</span>
            <span class="plan-validity">Validity: ${plan.validity} days</span>
            <span class="plan-earning">Daily: $${plan.daily}</span>
          </div>
          <button class="${!active?'buy-btn':'claim-btn'}" ${disabled?'disabled':''} data-plan="${plan.id}">${btnTxt}</button>
        `;
        row.querySelector('button').onclick = ()=>{
          if (!active) buyPlan(plan);
          else if (canClaim) claimPlan(plan);
        };
        plansEl.appendChild(row);
      });
    }
    function buyPlan(plan) {
      if ((userData.usdt||0) < plan.price) {
        showIsland("Insufficient USDT balance.");
        return;
      }
      if (userData.plans && userData.plans[plan.id] && userData.plans[plan.id].purchased) {
        showIsland("Plan already active.");
        return;
      }
      if (!confirm(`Buy ${plan.name} plan for $${plan.price}?`)) return;
      userData.usdt -= plan.price;
      if (!userData.plans) userData.plans = {};
      userData.plans[plan.id]={purchased:Date.now(), lastClaim:0};
      pushHistory({type:'buy',plan:plan.name,amt:plan.price,date:new Date().toLocaleString()});
      updateUserData({ usdt:userData.usdt, plans: userData.plans, history: userData.history });
      updateBalances();
      renderPlans();
      renderHistory();
      showIsland(`Bought ${plan.name} plan for $${plan.price}`);
      alert("Plan purchased successfully!");
    }
    function claimPlan(plan) {
      let userPlan = userData.plans[plan.id];
      if (!userPlan) return;
      let now = Date.now();
      if (now - (userPlan.lastClaim||0) < 24*3600*1000) {
        showIsland("Already claimed today.");
        return;
      }
      userData.usdt += plan.daily;
      userPlan.lastClaim = now;
      userData.plans[plan.id]=userPlan;
      pushHistory({type:'claim',plan:plan.name,amt:plan.daily,date:new Date().toLocaleString()});
      updateUserData({ usdt:userData.usdt, plans: userData.plans, history: userData.history });
      updateBalances();
      renderPlans();
      renderHistory();
      showIsland(`Claimed $${plan.daily} daily earning from ${plan.name} plan!`);
      alert(`Claimed $${plan.daily} for ${plan.name}!`);
    }

    // ---- Wallet Tabs ----
    document.getElementById('deposit-tab').onclick = ()=>showWalletTab('deposit');
    document.getElementById('withdraw-tab').onclick = ()=>showWalletTab('withdraw');
    document.getElementById('history-tab').onclick = ()=>showWalletTab('history');
    function showWalletTab(tab) {
      document.getElementById('deposit-section').classList.remove('active');
      document.getElementById('withdraw-section').classList.remove('active');
      document.getElementById('history-section').classList.remove('active');
      document.getElementById('deposit-tab').classList.remove('active');
      document.getElementById('withdraw-tab').classList.remove('active');
      document.getElementById('history-tab').classList.remove('active');
      if (tab==='deposit') {
        document.getElementById('deposit-section').classList.add('active');
        document.getElementById('deposit-tab').classList.add('active');
        renderDeposit();
      }
      else if (tab==='withdraw') {
        document.getElementById('withdraw-section').classList.add('active');
        document.getElementById('withdraw-tab').classList.add('active');
        renderWithdraw();
      }
      else if (tab==='history') {
        document.getElementById('history-section').classList.add('active');
        document.getElementById('history-tab').classList.add('active');
        renderHistory();
      }
    }
    showWalletTab('none');

    // ---- Deposit Section ----
    function renderDeposit() {
      let el = document.getElementById('deposit-section');
      el.innerHTML = `
        <div class="wallet-info-box">
          <b>Deposit USDT or TON into your wallet:</b><br>
          - Minimum TON amount is <b>3</b><br>
          - Minimum USDT amount is <b>10</b><br>
          - Use the correct wallet address and memo.<br>
          - Deposits are credited after confirmation.
        </div>
        <div class="form-row">
          <label>Deposit Method</label>
          <select id="deposit-method">
            <option value="ton"><img src="934817.png" class="wallet-method-img" /> TONCOIN</option>
            <option value="usdt"><img src="15207964.png" class="wallet-method-img" /> USDT TON</option>
          </select>
        </div>
        <div class="form-row" id="deposit-amount-row">
          <label id="deposit-amt-label">TON Amount (min 3)</label>
          <input type="number" id="deposit-amount" min="3" placeholder="Enter TON amount"/>
        </div>
        <button class="buy-btn" id="deposit-confirm-btn" style="margin-top:3px;">Proceed</button>
      `;
      let methodSel = el.querySelector('#deposit-method');
      let amtInput = el.querySelector('#deposit-amount');
      let amtLabel = el.querySelector('#deposit-amt-label');
      let confirmBtn = el.querySelector('#deposit-confirm-btn');
      function updateLabel() {
        let m = methodSel.value;
        amtLabel.innerHTML = m==='ton'
          ? `<img src="934817.png" class="wallet-method-img" /> TON Amount (min 3)`
          : `<img src="15207964.png" class="wallet-method-img" /> USDT Amount (min 10)`;
        amtInput.placeholder = m==='ton' ? "Enter TON amount" : "Enter USDT amount";
        amtInput.min = m==='ton' ? 3 : 10;
      }
      methodSel.onchange = updateLabel;
      updateLabel();
      confirmBtn.onclick = ()=>{
        let m = methodSel.value;
        let amt = parseFloat(amtInput.value);
        if (isNaN(amt) || amt < (m==='ton'?3:10)) {
          showIsland(`Minimum ${m==='ton'?'3 TON':'10 USDT'} required.`);
          return;
        }
        showDepositQR(m, amt);
      };
    }
    function showDepositQR(method, amt) {
      let el = document.getElementById('deposit-section');
      let addr = method==='ton'?"UQCOL7arveEVrKfKa9v3SbZnKjIBnOavmX3aXdDV-XD1cQ09":"UQCOL7arveEVrKfKa9v3SbZnKjIBnOavmX3aXdDV-XD1cQ09";
      let qr = method==='ton'?"https://github.com/s42144/Shark-Bounty/raw/1890e18b5008f67e6d057aa7a47149bfc84740fc/Screenshot_2025-09-12-18-54-13-944_com.ton_keeper-edit.jpg":"https://github.com/s42144/Shark-Bounty/raw/a23720d6a315d2422e3943aa7bf779beac9acdad/Screenshot_2025-09-12-18-54-50-676_com.ton_keeper-edit.jpg";
      let memo = randomMemo();
      let usdtVal = method==='ton'?amt*3.20:amt;
      let expire = Date.now()+15*60*1000;
      let timerId;
      function countdown() {
        let left = Math.max(0, Math.floor((expire-Date.now())/1000));
        let m = Math.floor(left/60), s = left%60;
        el.querySelector('.deposit-countdown').textContent = `Expires in: ${m}m ${s}s`;
        if (left <= 0) {
          clearInterval(timerId);
          el.innerHTML = `<div style="color:#ff556b; font-size:1.07rem;">Deposit session expired.<br><button class="buy-btn" onclick="showWalletTab('deposit')">Back</button></div>`;
        }
      }
      el.innerHTML = `
        <div class="deposit-countdown"></div>
        <div class="qr-section">
          <img src="${qr}" alt="Deposit QR"/>
        </div>
        <div class="deposit-info-box">
          <div class="deposit-address">Address: <span>${addr}</span>
            <button class="copy-btn" onclick="copy('${addr}')" title="Copy Address"><img src="1622069.png"></button>
          </div>
          <div class="deposit-memo">Memo/Comment: <span class="memo-label">${memo}</span>
            <button class="copy-btn" onclick="copy('${memo}')" title="Copy Memo"><img src="1622069.png"></button>
          </div>
          <div class="live-rate">
            You will get: <b>${usdtVal.toFixed(2)} USDT</b>
            <span style="color:#bbb; font-size:0.94rem;display:block;margin-top:3px;">(1 TON = $3.20)</span>
          </div>
        </div>
        <div style="text-align:center;margin-top:9px;">
          <button class="buy-btn" onclick="confirmDeposit('${method}',${amt},'${memo}',${usdtVal})">I have paid</button>
        </div>
      `;
      countdown();
      timerId = setInterval(countdown,1000);
    }
    function confirmDeposit(method, amt, memo, usdtVal) {
      const depositRef = db.ref('deposits').push();
      const depositData = {
        userid: getUserId(),
        method,
        amount: amt,
        memo,
        usdt: usdtVal,
        time: Date.now(),
        device: navigator.userAgent,
        status: "Pending"
      };
      depositRef.set(depositData);
      showIsland("Deposit request submitted. Await admin approval.");
      showWalletTab('history');
    }

    // ---- Withdraw ----
    function renderWithdraw() {
      let el = document.getElementById('withdraw-section');
      el.innerHTML = `
        <div class="wallet-info-box">
          <b>Withdraw USDT/TON:</b><br>
          - Minimum withdraw amount is <b>$3</b><br>
          - Enter your TON chain address<br>
          - Withdrawals are processed after review.
        </div>
        <div class="form-row">
          <label>Withdraw Method</label>
          <select id="withdraw-method">
            <option value="usdt"><img src="15207964.png" class="wallet-method-img" /> USDT TON</option>
            <option value="ton"><img src="934817.png" class="wallet-method-img" /> TONCOIN</option>
          </select>
        </div>
        <div class="form-row">
          <label>Amount (min $3)</label>
          <input type="number" id="withdraw-amount" min="3" placeholder="Enter amount"/>
        </div>
        <div class="form-row">
          <label>Address (TON chain)</label>
          <input type="text" id="withdraw-address" placeholder="Enter TON chain address"/>
        </div>
        <div class="form-row">
          <label>Memo/Comment (optional)</label>
          <input type="text" id="withdraw-memo" placeholder="Memo/Comment (optional)"/>
        </div>
        <button class="buy-btn" id="withdraw-confirm-btn" style="margin-top:3px;">Withdraw</button>
      `;
      el.querySelector('#withdraw-confirm-btn').onclick = ()=>{
        let method = el.querySelector('#withdraw-method').value;
        let amt = parseFloat(el.querySelector('#withdraw-amount').value);
        let addr = el.querySelector('#withdraw-address').value.trim();
        let memo = el.querySelector('#withdraw-memo').value.trim();
        if (isNaN(amt) || amt < 3) {
          showIsland("Minimum withdraw $3.");
          return;
        }
        if (!addr) {
          showIsland("Enter TON chain address.");
          return;
        }
        if ((userData.usdt||0) < amt) {
          showIsland("Insufficient USDT balance.");
          return;
        }
        if (!confirm("Confirm withdraw?")) return;
        const withdrawRef = db.ref('withdraws').push();
        const withdrawData = {
          userid: getUserId(),
          method,
          amount: amt,
          address: addr,
          memo,
          time: Date.now(),
          tonmemo: randomMemo(),
          status: "Pending"
        };
        withdrawRef.set(withdrawData);
        showIsland("Withdraw request submitted. Await admin approval.");
        showWalletTab('history');
      };
    }

    // ---- History ----
    function pushHistory(obj){
      if(!userData.history) userData.history = [];
      userData.history.push(obj);
      if(userData.history.length > 100) userData.history.shift();
    }
    function renderHistory() {
      let el = document.getElementById('history-section');
      el.innerHTML = '';
      // Fetch deposit and withdraw history
      db.ref('deposits').orderByChild('userid').equalTo(getUserId()).once('value').then(snap => {
        const deposits = snap.val() || {};
        Object.values(deposits).forEach(h=>{
          el.innerHTML += `<div class="history-item">
            <div class="history-txt"><b>Deposit</b> (${h.method}) <span style="color:#17f3a9;">+$${h.usdt}</span> <span style="color:#bbb;font-size:0.92em;">${h.status}</span></div>
            <div class="history-quote">
              Date: <i>${new Date(h.time).toLocaleString()}</i><br>
              Memo: <i>${h.memo}</i>
            </div>
          </div>`;
        });
      });
      db.ref('withdraws').orderByChild('userid').equalTo(getUserId()).once('value').then(snap => {
        const withdraws = snap.val() || {};
        Object.values(withdraws).forEach(h=>{
          el.innerHTML += `<div class="history-item">
            <div class="history-txt"><b>Withdraw</b> (${h.method}) <span style="color:#ff556b;">-$${h.amount}</span> <span style="color:#bbb;font-size:0.92em;">${h.status}</span></div>
            <div class="history-quote">
              Date: <i>${new Date(h.time).toLocaleString()}</i><br>
              Memo: <i>${h.memo}</i>
            </div>
          </div>`;
        });
      });
      // Local plan buy/claim history
      if(userData.history && userData.history.length){
        userData.history.slice().reverse().forEach(h=>{
          let txt = '';
          if (h.type==='buy') txt = `<b>Bought Plan:</b> ${h.plan} <span style="color:#ff61c9;">-$${h.amt}</span>`;
          else if (h.type==='claim') txt = `<b>Claimed:</b> ${h.plan} <span style="color:#17f3a9;">+$${h.amt}</span>`;
          el.innerHTML += `<div class="history-item">
            <div class="history-txt">${txt}</div>
            <div class="history-quote">Date: <i>${h.date}</i></div>
          </div>`;
        });
      }
    }

    // ---- Profile ----
    function renderProfile() {
      document.getElementById('profile-username').textContent = userData.username || "SharkUser";
      document.getElementById('profile-referral').textContent = userData.referral || "None";
      document.getElementById('profile-userid').textContent = userData.userid;
      document.getElementById('profile-joined').textContent = userData.joinedDate || (new Date()).toISOString().slice(0,10);
    }

    // ---- Notifications ----
    function renderProfileNotifications() {
      // Show both global and user-specific notifications
      let notifications = [];
      if(userData.notifications) notifications = notifications.concat(userData.notifications);
      if(userData.globalNotifications) notifications = notifications.concat(userData.globalNotifications);
      notifications.sort((a,b)=>b.date-a.date);
      // Modal
      let anchor = document.getElementById('profile-modal-anchor');
      // Only update modal if open and notifications modal is visible
      if (anchor.innerHTML && anchor.querySelector('.noti-modal')) {
        let list = notifications.length?notifications.slice().reverse().map(n=>`
          <div class="noti-item">${n.text}<span class="noti-date">${new Date(n.date).toLocaleString()}</span></div>
        `).join(""):`<div style="color:#bbb;text-align:center;">No notifications yet.</div>`;
        anchor.querySelector('.noti-list').innerHTML = list;
      }
    }

    // ---- Tasks UI ----
    function renderTasks() {
      let el = document.getElementById('tasks-ui');
      el.innerHTML = '';
      const tasks = userData.availableTasks || {};
      if(Object.keys(tasks).length===0){
        el.innerHTML = `<div style="margin-top: 44px;">
          <img src="16104409.png" style="width:65px;opacity:0.7;">
          <div style="margin-top: 14px; font-size:1.1rem;">No tasks available right now.</div>
          <div style="color:#789; font-size:0.98rem;">(Admin panel will provide tasks soon.)</div>
        </div>`;
        return;
      }
      Object.entries(tasks).forEach(([taskId, task])=>{
        el.innerHTML += `
        <div class="plan-card">
          <div class="plan-title">
            ${task.name}
            ${task.image?`<img src="${task.image}" class="plan-secure" title="Task Image"/>`:''}
          </div>
          <div class="plan-row">
            <span class="plan-price">SHB Reward: ${task.shb||0}</span>
            <span class="plan-price">USDT Reward: ${task.usdt||0}</span>
            <span class="plan-earning"><a href="${task.url}" target="_blank">${task.url}</a></span>
          </div>
          <button class="claim-btn" onclick="startTask('${taskId}')">Start</button>
        </div>
        `;
      });
    }
    function startTask(taskId){
      const tasks = userData.availableTasks || {};
      if(!tasks[taskId]) return;
      const task = tasks[taskId];
      // Add rewards if not already claimed
      if(!userData.tasks) userData.tasks = {};
      if(userData.tasks[taskId]) {
        showIsland("Already claimed this task.");
        return;
      }
      userData.shb = (userData.shb||0) + (task.shb||0);
      userData.usdt = (userData.usdt||0) + (task.usdt||0);
      userData.tasks[taskId] = true;
      updateUserData({ shb:userData.shb, usdt:userData.usdt, tasks:userData.tasks });
      showIsland(`Task "${task.name}" started! Rewards added.`);
      window.open(task.url, "_blank");
    }
    window.startTask = startTask;

    // ---- Redemption ----
    function showRedeemPage() {
      const el = document.getElementById('redeem-page');
      el.style.display = "flex";
      el.innerHTML = `
        <div class="redeem-box">
          <button class="modal-close" style="position:absolute;top:12px;right:13px;" onclick="closeProfileModal(event)">&times;</button>
          <div style="font-size:1.2em;font-weight:600;margin-bottom:11px;">Redeem Gift</div>
          <form id="redeem-form">
            <div class="redeem-form-row">
              <label>Redemption Code</label>
              <input type="text" id="redeem-code" required placeholder="Enter redemption code"/>
            </div>
            <button class="redeem-btn" type="submit">Redeem</button>
          </form>
          <div id="redeem-success" class="redeem-success"></div>
        </div>
      `;
      el.querySelector('#redeem-form').onsubmit = function(e){
        e.preventDefault();
        let code = el.querySelector('#redeem-code').value.trim();
        if(!code){
          el.querySelector('#redeem-success').innerHTML = `<span style="color:#ff556b;">Please enter a code!</span>`;
          return;
        }
        // Validate code from DB
        db.ref('redeem/' + code).once('value').then(snap=>{
          const d = snap.val();
          if(!d){
            el.querySelector('#redeem-success').innerHTML = `<span style="color:#ff556b;">Invalid code!</span>`;
            return;
          }
          if (!d.claimed) d.claimed = [];
          if (d.claimed.length >= (d.maxusers||1)) {
            el.querySelector('#redeem-success').innerHTML = `<span style="color:#ff556b;">Code already fully claimed!</span>`;
            return;
          }
          if (d.claimed.includes(getUserId())) {
            el.querySelector('#redeem-success').innerHTML = `<span style="color:#ff556b;">Already claimed by you!</span>`;
            return;
          }
          // Add USDT
          userData.usdt = (userData.usdt||0) + (d.usdt||0);
          updateUserData({ usdt:userData.usdt });
          // Mark as claimed
          d.claimed.push(getUserId());
          db.ref('redeem/' + code + '/claimed').set(d.claimed);
          el.querySelector('#redeem-success').innerHTML = `<span style="color:#15e58a;">Success! +${d.usdt} USDT added.</span>`;
        });
      }
    }
    window.showRedeemPage = showRedeemPage;

    // ---- Daily Check In ----
    function checkInDci() {
      let dci = userData.dci;
      let today = (new Date()).toDateString();
      let nextIdx = dci.progress.findIndex(v=>!v);
      let reward = [
        {shb:1000,usdt:0.10},
        {shb:2000,usdt:0.20},
        {shb:3000,usdt:0.30},
        {shb:4000,usdt:0.40},
        {shb:5000,usdt:0.50},
        {shb:6000,usdt:0.60},
        {shb:7000,usdt:0.70}
      ];
      if (nextIdx!==-1 && dci.last!==today) {
        dci.progress[nextIdx]=true;
        dci.last=today;
        userData.dci=dci;
        userData.shb+=reward[nextIdx].shb;
        userData.usdt+=reward[nextIdx].usdt;
        if(!userData.notifications) userData.notifications = [];
        userData.notifications.push({text:`Checked in - ${reward[nextIdx].shb} SHB & ${reward[nextIdx].usdt} USDT added!`,date:Date.now()});
        updateUserData({ dci:userData.dci, shb:userData.shb, usdt:userData.usdt, notifications:userData.notifications });
        updateBalances();
        renderHistory();
        showProfileModal('dci');
      }
    }
    window.checkInDci = checkInDci;

    // ---- Utility ----
    function copy(txt) {
      navigator.clipboard.writeText(txt);
      showIsland("Copied!");
    }
    window.copy = copy;

    function randomMemo() {
      let s = '';
      let chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ123456789';
      for (let i=0;i<7;i++) s+=chars[Math.floor(Math.random()*chars.length)];
      return s;
    }

    // ---- Modal Logic ----
    function showProfileModal(type) {
      let anchor = document.getElementById('profile-modal-anchor');
      anchor.innerHTML = "";
      if (type==='referral') {
        anchor.innerHTML = `<div class="modal-bg" onclick="closeProfileModal(event)">
          <div class="modal-box" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeProfileModal(event)">&times;</button>
            <div style="font-size:1.2em;font-weight:600;margin-bottom:11px;">Referrals</div>
            <div style="padding:17px 4px;text-align:center;">Referral features <span style="color:#17f3a9;">Coming soon!</span></div>
          </div>
        </div>`;
      }
      if (type==='leaderboard') {
        anchor.innerHTML = `<div class="modal-bg" onclick="closeProfileModal(event)">
          <div class="modal-box" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeProfileModal(event)">&times;</button>
            <div class="leaderboard-title">Leaderboard</div>
            <div style="max-height:64vh;overflow:auto;">Coming soon!</div>
          </div>
        </div>`;
      }
      if (type==='dci') {
        let dci = userData.dci;
        let reward = [
          {shb:1000,usdt:0.10},
          {shb:2000,usdt:0.20},
          {shb:3000,usdt:0.30},
          {shb:4000,usdt:0.40},
          {shb:5000,usdt:0.50},
          {shb:6000,usdt:0.60},
          {shb:7000,usdt:0.70}
        ];
        let days = "";
        for (let i=0;i<7;i++) days+=`
          <div class="dci-day${dci.progress[i]?' claimed':''}">
            <span class="dci-day-title">Day ${i+1}</span>
            <span class="dci-reward">${reward[i].shb} SHB<br>${reward[i].usdt} USDT</span>
            ${dci.progress[i]?'<span style="color:#fff;font-size:0.94em;margin
