<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shark Bounty</title>
    <style>
        /* CSS for Mobile Responsiveness and UI */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: manipulation; /* Improves touch responsiveness */
        }
        .container {
            flex-grow: 1;
            padding: 10px;
            max-width: 500px;
            width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
            position: relative;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }
        #balance-container {
            font-size: 1.2em;
            font-weight: bold;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 15px;
        }
        .energy-bar-container {
            width: 100%;
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
        }
        #energy-bar {
            height: 100%;
            background-color: #00f080;
            transition: width 0.1s linear;
        }
        .main-content {
            text-align: center;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-bottom: 80px; /* Space for the bottom nav */
        }
        .coin-area {
            position: relative;
            width: 300px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
        }
        #coin-gif {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.3);
            -webkit-user-drag: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
        }
        .earning-animation {
            position: absolute;
            font-size: 3em;
            font-weight: bolder;
            color: #00f080;
            pointer-events: none;
            opacity: 0;
            transition: all 0.5s ease-out;
            transform: translateY(0);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            background-color: rgba(17, 17, 17, 0.95);
            padding: 5px 0;
            border-top: 1px solid #333;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px;
            color: #ccc;
            font-size: 0.7em;
            cursor: pointer;
            transition: color 0.2s;
        }
        .nav-item.active {
            color: #fff;
        }
        .nav-item img {
            width: 30px;
            height: 30px;
            margin-bottom: 2px;
            filter: grayscale(100%);
            transition: filter 0.2s;
        }
        .nav-item.active img {
            filter: grayscale(0%);
        }

        /* Section Specific Styles (Booster, Earn, Tasks, Profile, Ranking) */
        .section-view {
            display: none;
            width: 100%;
            text-align: left;
            padding: 20px 0;
        }
        .section-view.active {
            display: block;
        }
        
        /* Dynamic Island Notification (Simplified) */
        #dynamic-island {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #222;
            color: #fff;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            z-index: 200;
            min-width: 100px;
            text-align: center;
        }
        #dynamic-island.show {
            opacity: 1;
            transform: translate(-50%, 0);
        }
        
        /* Booster Section */
        .booster-item {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
        }
        .booster-item-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.15;
            z-index: 0;
        }
        .booster-content {
            position: relative;
            z-index: 1;
        }
        .booster-button {
            background-color: #00f080;
            color: #000;
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            float: right;
        }
        
        /* Task Section */
        .task-list {
            margin-top: 15px;
        }
        .task-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .task-info {
            display: flex;
            align-items: center;
        }
        .task-info img {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            margin-right: 10px;
        }
        .task-button {
            background-color: #007bff;
            color: #fff;
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }
        .task-button.completed {
            background-color: #555;
            cursor: default;
        }
        
        /* Profile Section */
        .profile-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .profile-header img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #00f080;
            object-fit: cover;
        }
        .userid-box {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .copy-button {
            background: none;
            border: none;
            cursor: pointer;
            margin-left: 10px;
        }
        .copy-button img {
            width: 20px;
            height: 20px;
            vertical-align: middle;
        }
        .profile-form input {
            width: calc(100% - 22px);
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            border: 1px solid #444;
            background-color: #222;
            color: #fff;
        }
        .profile-form button {
            margin-top: 10px;
            width: 100%;
            padding: 10px;
            background-color: #00f080;
            color: #000;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Ranking Section */
        .ranking-list {
            list-style: none;
            padding: 0;
        }
        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }
        .ranking-item:last-child {
            border-bottom: none;
        }
        .ranking-item span {
            font-weight: bold;
        }
        
        /* Redeem Section */
        .redeem-box {
            text-align: center;
            padding: 30px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        .redeem-box input {
            width: 150px;
            text-align: center;
            font-size: 1.5em;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            border: 1px solid #444;
            background-color: #222;
            color: #fff;
        }
        .redeem-box button {
            padding: 10px 20px;
            background-color: #ff4500;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Intro Video Overlay */
        #video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #intro-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    </style>
    <script src='//libtl.com/sdk.js' data-zone='9970324' data-sdk='show_9970324'></script>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics.js";
      import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAHofuS76xf2oGPaJqEtopmcxdoJzjkDL4",
        authDomain: "zmex-investments.firebaseapp.com",
        databaseURL: "https://zmex-investments-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "zmex-investments",
        storageBucket: "zmex-investments.firebasestorage.app",
        messagingSenderId: "971623941364",
        appId: "1:971623941364:web:6c65604fc45c3f64e74aa1",
        measurementId: "G-KQ1LYP77JF"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const db = getDatabase(app);

      // Expose necessary Firebase functions globally for use in the main script block
      window.firebase = {
          db,
          ref,
          set,
          onValue,
          update
      };

      // **NOTE**: The admin SDK (var admin = require("firebase-admin");) is for Node.js/Server environments and cannot run in a browser. The admin panel logic must be implemented on a secure server/backend that uses the Admin SDK.
    </script>
</head>
<body>

    <div id="video-overlay">
        <video id="intro-video" src="https://github.com/s42144/Shark-Bounty/raw/8b67f2028cd3d33d6545243ea43a57958c428edf/29f4182c-fb84-4f6e-830f-f560ae571afe.mp4" playsinline autoplay muted></video>
    </div>

    <div id="dynamic-island">Notification Text</div>

    <div class="container">
        <div class="top-bar">
            <div id="balance-container">
                üí∞ <span id="shb-balance">0</span> SHB
            </div>
            <div></div> 
        </div>

        <div class="energy-info">
            <div style="font-size: 0.8em; margin-bottom: 5px;">
                ‚ö°Ô∏è <span id="current-energy">1200</span> / <span id="max-energy">1200</span>
            </div>
            <div class="energy-bar-container">
                <div id="energy-bar"></div>
            </div>
        </div>

        <div id="views">
            <div id="home-view" class="section-view active">
                <div class="main-content">
                    <p style="font-size: 1.2em;">Tap the coin to earn!</p>
                    <div class="coin-area" id="coin-tap-area">
                        <img id="coin-gif" src="https://raw.githubusercontent.com/s42144/Shark-Bounty/aeb441877b43b7401af99870ead870597d62f885/17510103.gif" alt="Coin">
                    </div>
                </div>
            </div>

            <div id="booster-view" class="section-view">
                <h2>üöÄ Boosters</h2>
                <div class="booster-item" id="increase-energy-booster">
                    <img class="booster-item-bg" src="https://raw.githubusercontent.com/s42144/Shark-Bounty/79fd7356e653ad0460b3d96e51be077d49c2255e/images%20(2).png" alt="Increase Energy BG">
                    <div class="booster-content">
                        <h3>Increase Max Energy</h3>
                        <p>Increase Max Energy by +500.</p>
                        <p>Price: **10000 SHB**</p>
                        <button class="booster-button" onclick="buyBooster('energy')">BUY</button>
                    </div>
                </div>
                
                <div class="booster-item" id="multi-tap-booster">
                    <img class="booster-item-bg" src="https://raw.githubusercontent.com/s42144/Shark-Bounty/f3ddf6b3fe4ecd6276ce8ff07b54c35ed8cab5ea/images%20(3).png" alt="Multi Tap BG">
                    <div class="booster-content">
                        <h3>Allow Multi-Finger Tapping (Level <span id="multi-tap-level">0</span>)</h3>
                        <p>Allows 2/4 fingers to tap simultaneously.</p>
                        <p>Price: **15000 SHB**</p>
                        <button class="booster-button" onclick="buyBooster('multi-tap')" id="multi-tap-button">BUY</button>
                    </div>
                </div>
                
                <div class="booster-item" id="income-booster">
                    <img class="booster-item-bg" src="https://raw.githubusercontent.com/s42144/Shark-Bounty/67f79ce003358d837c24fccb6df407f1ff52175e/images%20(4).png" alt="Income Booster BG">
                    <div class="booster-content">
                        <h3>Passive Income Booster (Offline Earnings)</h3>
                        <p>Earn **1 SHB** every **10 seconds**, even when offline.</p>
                        <p>Price: **100000 SHB** (Limit 1)</p>
                        <button class="booster-button" onclick="buyBooster('income')" id="income-booster-button">BUY</button>
                    </div>
                </div>
            </div>

            <div id="earn-view" class="section-view">
                <h2>üíµ Earn More SHB</h2>
                
                <div class="booster-item">
                    <div class="booster-content">
                        <h3>SHOW ADS (Monetag)</h3>
                        <p>Watch an ad to earn **500 SHB**.</p>
                        <p>Ads Seen Today: <span id="ads-today">0</span> / Daily: <span id="ads-daily">0</span> / Monthly: <span id="ads-monthly">0</span> / Lifetime: <span id="ads-lifetime">0</span></p>
                        <button class="booster-button" onclick="showMonetagAd()">SHOW ADS</button>
                    </div>
                </div>
                
                <div class="booster-item redeem-box">
                    <h3>Redeem Code</h3>
                    <input type="number" id="redeem-code-input" placeholder="4-digit code" maxlength="4">
                    <button onclick="redeemCode()">REDEEM</button>
                </div>

            </div>

            <div id="tasks-view" class="section-view">
                <h2>üìã Community Tasks</h2>
                <div class="task-list" id="active-tasks-list">
                    <p style="color: #ccc;">Tasks loading from database...</p>
                </div>
            </div>

            <div id="profile-view" class="section-view">
                <div class="profile-header">
                    <img src="https://raw.githubusercontent.com/s42144/Shark-Bounty/11c6e035a7f8f6445526ea07f34893fd3ceec419/18827926.png" alt="User Avatar">
                    <div class="userid-box">
                        **User ID:** <span id="user-id-display">Generating...</span>
                        <button class="copy-button" onclick="copyToClipboard('user-id-display', 'User ID copied!')">
                            <img src="https://raw.githubusercontent.com/s42144/Shark-Bounty/177e7fb2815726b7d9710a58dccafff013e0a531/1622069.png" alt="Copy">
                        </button>
                    </div>
                </div>

                <h3>Wallet Address</h3>
                <form class="profile-form">
                    <input type="text" id="ton-wallet-input" placeholder="Enter TON Wallet Address">
                    <button type="button" onclick="saveTonWallet()">SAVE</button>
                </form>
                
                <hr style="border-color: #333; margin: 20px 0;">
                
                <h3>üë• Referrals</h3>
                <div class="userid-box" style="flex-direction: column; align-items: flex-start;">
                    <p style="margin-bottom: 5px;">**Your Referral Link:**</p>
                    <div style="display: flex; width: 100%; justify-content: space-between; align-items: center;">
                        <span id="referral-link-display" style="word-break: break-all; font-size: 0.8em;">https://t.me/SharkBountybot?start=r_</span>
                        <button class="copy-button" onclick="copyToClipboard('referral-link-display', 'Referral link copied!')">
                            <img src="https://raw.githubusercontent.com/s42144/Shark-Bounty/177e7fb2815726b7d9710a58dccafff013e0a531/1622069.png" alt="Copy">
                        </button>
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    Total Referrals: **<span id="total-referrals">0</span>**
                </div>
            </div>
            
            <div id="ranking-view" class="section-view">
                <h2>üèÜ Top 200 Rank</h2>
                <ul class="ranking-list" id="ranking-list">
                    <p style="color: #ccc;">Ranks loading from database...</p>
                </ul>
            </div>
            
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" data-view="home">
            <img src="https://raw.githubusercontent.com/s42144/Shark-Bounty/dedf1f3379f4a52180a500e818e467dcd99f56c9/1057118.png" alt="Home">
            <span>Home</span>
        </div>
        <div class="nav-item" data-view="booster">
            <img src="https://raw.githubusercontent.com/s42144/Shark-Bounty/afd79a5abbf33e4b89606ee8f02538a8d385b1d9/images%20(1).png" alt="Booster">
            <span>Booster</span>
        </div>
        <div class="nav-item" data-view="earn">
            <img src="https://raw.githubusercontent.com/s42144/Shark-Bounty/e39a21566184e34a27cd1d48c67c6bd04429acde/images%20(4).jpeg" alt="Earn">
            <span>Earn</span>
        </div>
        <div class="nav-item" data-view="tasks">
            <img src="https://raw.githubusercontent.com/s42144/Shark-Bounty/2ba42299505308ea4ff2a68f5db8341f3ddc0e92/16104409.png" alt="Tasks">
            <span>Tasks</span>
        </div>
        <div class="nav-item" data-view="profile">
            <img src="https://raw.githubusercontent.com/s42144/Shark-Bounty/11c6e035a7f8f6445526ea07f34893fd3ceec419/18827926.png" alt="Profile">
            <span>Profile</span>
        </div>
        <div class="nav-item" data-view="ranking">
            <img src="https://raw.githubusercontent.com/s42144/Shark-Bounty/74b1e06fd560efe8e058569ffa7b4e363aa1c43d/13311710.png" alt="Ranking">
            <span>Ranking</span>
        </div>
    </div>

    <script>
        // --- Game State Variables ---
        let SHB_BALANCE = 0;
        let MAX_ENERGY = 1200;
        let CURRENT_ENERGY = 1200;
        let ENERGY_REGEN_RATE = 1; // 1 energy per 2 seconds
        let MULTI_TAP_LEVEL = 0; // 0: 1 finger, 1: 2 fingers, 2: 4 fingers
        let TAP_FINGERS = 1;
        let INCOME_BOOSTER_ACTIVE = false;
        let EARNING_PER_TAP = 1;
        
        // --- DOM Elements ---
        const balanceDisplay = document.getElementById('shb-balance');
        const currentEnergyDisplay = document.getElementById('current-energy');
        const maxEnergyDisplay = document.getElementById('max-energy');
        const energyBar = document.getElementById('energy-bar');
        const coinTapArea = document.getElementById('coin-tap-area');
        const views = document.querySelectorAll('.section-view');
        const navItems = document.querySelectorAll('.nav-item');
        const dynamicIsland = document.getElementById('dynamic-island');
        const userIdDisplay = document.getElementById('user-id-display');
        const referralLinkDisplay = document.getElementById('referral-link-display');
        const introVideo = document.getElementById('intro-video');
        const videoOverlay = document.getElementById('video-overlay');
        
        // --- Unique User ID Generation (Placeholder) ---
        // In a real application, this would be generated and stored securely on the server/database.
        let USER_ID = localStorage.getItem('user_id');
        if (!USER_ID) {
            USER_ID = 'user_' + Math.random().toString(36).substring(2, 10);
            localStorage.setItem('user_id', USER_ID);
        }
        userIdDisplay.textContent = USER_ID;
        referralLinkDisplay.textContent = `https://t.me/SharkBountybot?start=r_${USER_ID}`;
        
        // --- Data Persistence (Simplified Local Storage for Demo) ---
        function loadUserData() {
            SHB_BALANCE = parseInt(localStorage.getItem('shb_balance') || 0);
            MAX_ENERGY = parseInt(localStorage.getItem('max_energy') || 1200);
            CURRENT_ENERGY = parseInt(localStorage.getItem('current_energy') || MAX_ENERGY);
            MULTI_TAP_LEVEL = parseInt(localStorage.getItem('multi_tap_level') || 0);
            TAP_FINGERS = MULTI_TAP_LEVEL === 1 ? 2 : MULTI_TAP_LEVEL === 2 ? 4 : 1;
            INCOME_BOOSTER_ACTIVE = localStorage.getItem('income_booster') === 'true';
            
            updateUI();
            
            // Re-calculate energy after loading, considering offline time
            recoverEnergy();
            
            // Start passive income if active
            if (INCOME_BOOSTER_ACTIVE) {
                startPassiveIncome();
            }
        }

        function saveUserData() {
            localStorage.setItem('shb_balance', SHB_BALANCE);
            localStorage.setItem('max_energy', MAX_ENERGY);
            localStorage.setItem('current_energy', CURRENT_ENERGY);
            localStorage.setItem('multi_tap_level', MULTI_TAP_LEVEL);
            localStorage.setItem('income_booster', INCOME_BOOSTER_ACTIVE);
            localStorage.setItem('last_save_time', Date.now()); // For passive income/regen calculation
        }
        
        // --- UI Update Function ---
        function updateUI() {
            balanceDisplay.textContent = SHB_BALANCE;
            currentEnergyDisplay.textContent = Math.floor(CURRENT_ENERGY);
            maxEnergyDisplay.textContent = MAX_ENERGY;
            energyBar.style.width = `${(CURRENT_ENERGY / MAX_ENERGY) * 100}%`;
            document.getElementById('multi-tap-level').textContent = MULTI_TAP_LEVEL;
            
            // Update Booster buttons state
            document.getElementById('income-booster-button').textContent = INCOME_BOOSTER_ACTIVE ? 'OWNED' : 'BUY';
            document.getElementById('income-booster-button').disabled = INCOME_BOOSTER_ACTIVE;

            if (MULTI_TAP_LEVEL >= 2) {
                document.getElementById('multi-tap-button').textContent = 'MAXED';
                document.getElementById('multi-tap-button').disabled = true;
            } else {
                document.getElementById('multi-tap-button').textContent = 'BUY';
                document.getElementById('multi-tap-button').disabled = false;
            }
        }
        
        // --- Dynamic Island Notification ---
        function showNotification(message) {
            dynamicIsland.textContent = message;
            dynamicIsland.classList.add('show');
            setTimeout(() => {
                dynamicIsland.classList.remove('show');
            }, 3000);
        }

        // --- Core Game Logic ---
        
        function handleCoinTap(event) {
            // Use changedTouches for multi-touch support
            const touches = event.changedTouches ? Array.from(event.changedTouches) : [event];
            const activeTaps = touches.length;

            if (activeTaps > TAP_FINGERS) {
                 // Ignore taps beyond the allowed multi-tap level
                return;
            }
            
            if (CURRENT_ENERGY >= activeTaps) {
                SHB_BALANCE += activeTaps * EARNING_PER_TAP;
                CURRENT_ENERGY -= activeTaps;
                
                // Show earning animation for each tap
                touches.forEach(touch => {
                    const tapX = touch.clientX || event.clientX;
                    const tapY = touch.clientY || event.clientY;
                    
                    showEarningAnimation(tapX, tapY, activeTaps);
                });

                // Update UI and save state
                updateUI();
                saveUserData();
            } else {
                showNotification("‚ö°Ô∏è Not enough energy!");
            }
        }

        function showEarningAnimation(x, y, amount) {
            const animation = document.createElement('div');
            animation.textContent = `+${amount}`;
            animation.classList.add('earning-animation');
            
            // Position near the tap location
            animation.style.left = `${x}px`;
            animation.style.top = `${y}px`;
            
            // Append and animate
            document.body.appendChild(animation);
            
            // Force reflow to ensure transition starts
            void animation.offsetWidth; 
            
            animation.style.opacity = 1;
            animation.style.transform = `translateY(-50px) translateX(${Math.random() * 20 - 10}px)`; // Drift up and slightly sideways
            
            setTimeout(() => {
                animation.style.opacity = 0;
                // Use a short timeout to allow the transition to complete before removal
                setTimeout(() => animation.remove(), 500); 
            }, 100);
        }
        
        // --- Energy Recovery Logic ---
        function recoverEnergy() {
            const lastSaveTime = parseInt(localStorage.getItem('last_save_time') || Date.now());
            const now = Date.now();
            const timeDiffSeconds = Math.floor((now - lastSaveTime) / 1000);
            
            // 1 energy every 2 seconds = 0.5 energy per second
            const recoveredEnergy = timeDiffSeconds * (ENERGY_REGEN_RATE / 2);
            
            CURRENT_ENERGY = Math.min(MAX_ENERGY, CURRENT_ENERGY + recoveredEnergy);
            
            // Continuous regeneration loop
            setInterval(() => {
                if (CURRENT_ENERGY < MAX_ENERGY) {
                    CURRENT_ENERGY = Math.min(MAX_ENERGY, CURRENT_ENERGY + (ENERGY_REGEN_RATE / 2)); // Add energy equivalent to 1 second of regen
                    updateUI();
                }
            }, 1000); // Check and update every second
            
            updateUI();
            saveUserData();
        }

        // --- Passive Income Logic ---
        function startPassiveIncome() {
            if (!INCOME_BOOSTER_ACTIVE) return;

            // Handle offline earnings
            const lastSaveTime = parseInt(localStorage.getItem('last_save_time') || Date.now());
            const now = Date.now();
            const timeDiffSeconds = Math.floor((now - lastSaveTime) / 1000);
            
            // Earn 1 SHB every 10 seconds
            const passiveEarnings = Math.floor(timeDiffSeconds / 10) * 1;
            
            if (passiveEarnings > 0) {
                SHB_BALANCE += passiveEarnings;
                showNotification(`üí∞ Offline Passive Earnings: +${passiveEarnings} SHB`);
                saveUserData();
            }

            // Start continuous passive income timer
            setInterval(() => {
                if (INCOME_BOOSTER_ACTIVE) {
                    SHB_BALANCE += 1;
                    updateUI();
                    saveUserData();
                    // Optionally show a small notification
                    // showNotification('+1 SHB (Passive)');
                }
            }, 10000); // Every 10 seconds
        }

        // --- Booster Logic ---
        function buyBooster(type) {
            let price, success = false;
            
            switch(type) {
                case 'energy':
                    price = 10000;
                    if (SHB_BALANCE >= price) {
                        SHB_BALANCE -= price;
                        MAX_ENERGY += 500;
                        CURRENT_ENERGY += 500; // Add energy equivalent to the increase in max
                        success = true;
                    }
                    break;
                case 'multi-tap':
                    price = 15000;
                    if (MULTI_TAP_LEVEL < 2 && SHB_BALANCE >= price) {
                        SHB_BALANCE -= price;
                        MULTI_TAP_LEVEL++;
                        TAP_FINGERS = MULTI_TAP_LEVEL === 1 ? 2 : 4;
                        success = true;
                    }
                    break;
                case 'income':
                    price = 100000;
                    if (!INCOME_BOOSTER_ACTIVE && SHB_BALANCE >= price) {
                        SHB_BALANCE -= price;
                        INCOME_BOOSTER_ACTIVE = true;
                        startPassiveIncome();
                        success = true;
                    }
                    break;
            }

            if (success) {
                showNotification(`‚úÖ ${type.toUpperCase()} Booster Purchased!`);
                updateUI();
                saveUserData();
            } else if (SHB_BALANCE < price) {
                showNotification("‚ùå Not enough SHB!");
            } else if (type === 'income' && INCOME_BOOSTER_ACTIVE) {
                 showNotification("‚ùå Already owned this booster!");
            } else if (type === 'multi-tap' && MULTI_TAP_LEVEL >= 2) {
                 showNotification("‚ùå Multi-Tap is MAXED!");
            }
        }
        
        // --- Navigation ---
        function switchView(viewId) {
            views.forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');

            navItems.forEach(item => item.classList.remove('active'));
            document.querySelector(`.nav-item[data-view="${viewId.replace('-view', '')}"]`).classList.add('active');
        }
        
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                switchView(item.getAttribute('data-view') + '-view');
            });
        });

        // --- Utility Functions ---
        function copyToClipboard(elementId, successMessage) {
            const textToCopy = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(textToCopy).then(() => {
                showNotification(successMessage);
            }).catch(err => {
                console.error('Could not copy text: ', err);
                showNotification('Copy failed. Try manually.');
            });
        }
        window.copyToClipboard = copyToClipboard; // Expose to global scope for HTML onclick

        // --- Ad Network and Redeem (PLACEHOLDERS) ---
        function showMonetagAd() {
            // **Monetag Integration:** The SDK is included, but calling an ad function depends on the Monetag method, which is often `show_9970324()` or a specific global function. We simulate success here.
            
            // This is a SIMULATION of a successful ad view
            setTimeout(() => {
                SHB_BALANCE += 500;
                // In a real app, you'd increment ad counters and update Firebase here.
                showNotification("üéâ +500 SHB for watching an ad!");
                updateUI();
                saveUserData();
            }, 1000); // Simulate ad delay
            
            // In a real app, this is where you'd call the ad display function:
            // if (window.show_9970324) { window.show_9970324(); }
        }
        window.showMonetagAd = showMonetagAd;

        function redeemCode() {
            const code = document.getElementById('redeem-code-input').value;
            if (code.length !== 4) {
                showNotification("‚ùå Code must be 4 digits.");
                return;
            }
            
            // **Redeem Logic:** This requires server-side/Firebase functions to check if the code is valid, has not been used, and then delete/mark as used.
            // Placeholder: Assume code '1234' is always valid for demo
            if (code === '1234') {
                SHB_BALANCE += 500;
                showNotification("üéÅ Redeem successful! +500 SHB!");
            } else {
                 showNotification("‚ùå Invalid Redeem Code.");
            }
            document.getElementById('redeem-code-input').value = '';
            updateUI();
            saveUserData();
        }
        window.redeemCode = redeemCode;
        
        function saveTonWallet() {
            const wallet = document.getElementById('ton-wallet-input').value;
            // In a real app, this data would be saved to Firebase under the USER_ID node.
            localStorage.setItem('ton_wallet', wallet);
            showNotification("‚úÖ TON Wallet Saved!");
            
            // For persistence
            document.getElementById('ton-wallet-input').value = localStorage.getItem('ton_wallet') || '';
        }
        window.saveTonWallet = saveTonWallet;
        
        // --- Initialisation ---
        window.onload = () => {
            // 1. Play Intro Video
            introVideo.addEventListener('ended', () => {
                videoOverlay.style.display = 'none';
            });
            introVideo.addEventListener('loadedmetadata', () => {
                introVideo.play().catch(error => {
                    // Autoplay blocked, hide overlay immediately
                    console.log("Autoplay blocked. Hiding video overlay.");
                    videoOverlay.style.display = 'none';
                });
            });

            // If video fails to load or autoplays is blocked, ensure the overlay is removed.
            setTimeout(() => {
                if (videoOverlay.style.display !== 'none') {
                    videoOverlay.style.display = 'none';
                }
            }, 5000); // 5 seconds grace period

            // 2. Load Data and Start Game Loop
            loadUserData();
            
            // 3. Attach Tap/Touch Listeners
            // Use 'touchstart' and prevent default to handle mobile touch events efficiently
            coinTapArea.addEventListener('touchstart', (e) => {
                e.preventDefault(); // Prevents zooming/scrolling
                handleCoinTap(e);
            }, { passive: false });
            
            // Fallback for desktop/simulators
            coinTapArea.addEventListener('click', handleCoinTap);
            
            // Set initial wallet display
            document.getElementById('ton-wallet-input').value = localStorage.getItem('ton_wallet') || '';
            
            // 4. Initial Firebase Data Load/Sync (Simplified)
            // In a full application, this is where you'd sync local state with a secured Firebase Realtime Database node for the USER_ID.
            // Example of a basic read:
            // const userRef = window.firebase.ref(window.firebase.db, 'users/' + USER_ID);
            // window.firebase.onValue(userRef, (snapshot) => {
            //     const data = snapshot.val();
            //     if (data) {
            //          // Overwrite/merge local state with remote data
            //     }
            // });
        };
    </script>
</body>
</html>
